{"title":"Endogeniety I: IV and 2SLS","markdown":{"headingText":"Endogeniety I: IV and 2SLS","containsRefs":false,"markdown":"\\DeclareMathOperator{\\plim}{plim}\n\\DeclareMathOperator{\\argmin}{argmin}\n\\DeclareMathOperator{\\argmax}{argmax}\n\\newcommand{\\var}[1]{\\text{Var}\\left(#1\\right)}\n\\newcommand{\\avar}[1]{\\text{Avar}\\left(#1\\right)}\n\\newcommand{\\E}[1]{\\text{E}\\left[#1\\right]}\n\\newcommand{\\cov}[1]{\\text{Cov}\\left(#1\\right)}\n\\newcommand{\\mse}[1]{\\text{MSE}\\left(#1\\right)}\n\\newcommand{\\se}[1]{\\text{se}\\left(#1\\right)}\n\\newcommand{\\limfunc}{lim} \n\\newcommand{\\X}{\\mathbf{X}}\n\\newcommand{\\Xm}{\\mathbb{X}}\n\\newcommand{\\EER}{\\bar{\\thet}_\\text{EE}}\n\\newcommand{\\NLS}{\\hat{\\bet}_\\text{NLLS}}\n\\newcommand{\\z}{\\mathbf{z}}\n\\newcommand{\\rr}{\\mathbf{r}}\n\\newcommand{\\C}{\\mathbf{C}}\n\\newcommand{\\Pe}{\\mathbf{P}}\n\\newcommand{\\y}{\\mathbf{y}}\n\\newcommand{\\Y}{\\mathbf{Y}}\n\\newcommand{\\uu}{\\mathbf{u}}\n\\newcommand{\\e}{\\mathbf{e}}\n\\newcommand{\\D}{\\mathbf{D}}\n\\newcommand{\\x}{\\mathbf{x}}\n\\newcommand{\\xm}{\\mathbb{x}}\n\\newcommand{\\Zm}{\\mathbb{Z}}\n\\newcommand{\\Wm}{\\mathbb{W}}\n\\newcommand{\\Hm}{\\mathbb{H}}\n\\newcommand{\\W}{\\mathbf{W}}\n\\newcommand{\\Z}{\\mathbf{Z}}\n\\newcommand{\\Hess}{\\mathbf{H}(\\mathbf{\\Z\\mid\\thet})}\n\\newcommand{\\Score}{\\mathbf{S}(\\mathbf{\\Z\\mid\\thet})}\n\\newcommand{\\A}{\\mathbf{A}}\n\\newcommand{\\h}{\\mathbf{h}}\n\\newcommand{\\Q}{\\mathbf{Q}}\n\\newcommand{\\F}{\\mathbf{F}}\n\\newcommand{\\G}{\\mathbf{G}}\n\\newcommand{\\I}{\\mathbf{I}}\n\\renewcommand{\\D}{\\mathbf{D}}\n\\renewcommand{\\C}{\\mathbf{C}}\n\\newcommand{\\zer}{\\mathbf{0}}\n\\newcommand{\\OLS}{\\hat{\\boldsymbol\\beta}_\\text{OLS} }\n\\newcommand{\\OLSOV}{\\hat{\\boldsymbol\\beta}_\\text{OLS,OV} }\n\\newcommand{\\OLSME}{\\hat{\\boldsymbol\\beta}_\\text{OLS,ME} }\n\\newcommand{\\EE}{\\hat{\\boldsymbol\\theta}_\\text{EX} }\n\\newcommand{\\ME}{\\hat{\\boldsymbol\\theta}_\\text{M} }\n\\newcommand{\\MDE}{\\hat{\\boldsymbol\\theta}_\\text{MDE} }\n\\newcommand{\\IV}{\\hat{\\boldsymbol\\beta}_\\text{IV} }\n\\newcommand{\\TSLS}{\\hat{\\boldsymbol\\beta}_\\text{2SLS} }\n\\newcommand{\\thet}{\\boldsymbol{\\theta}}\n\\newcommand{\\et}{\\boldsymbol{\\eta}}\n\\newcommand{\\R}{\\mathbb{R}}\n\\newcommand{\\Sig}{\\boldsymbol{\\Sigma}}\n\\newcommand{\\ep}{\\boldsymbol{\\varepsilon}}\n\\newcommand{\\Omeg}{\\boldsymbol{\\Omega}}\n\\newcommand{\\Thet}{\\boldsymbol{\\Theta}}\n\\newcommand{\\bet}{\\boldsymbol{\\beta}}\n\\newcommand{\\rk}{rank}\n\\newcommand{\\tsum}{\\sum}\n\\newcommand{\\tr}{tr}\n\\newcommand{\\norm}[1]{\\left\\lVert#1\\right\\rVert}\n\\newcommand{\\abs}[1]{\\left\\lvert#1\\right\\rvert}\n\\newcommand{\\ms}{\\overset{ms}{\\to}}\n\\newcommand{\\pto}{\\overset{p}{\\to}}\n\\newcommand{\\iid}{\\overset{iid}{\\sim}}\n\\newcommand{\\dto}{\\overset{d}{\\to}}\n\\newcommand{\\asim}{\\overset{a}{\\sim}}\n\n\n```{r}\n#| echo: false\n#| message: false\nlibrary(tidyverse)\nlibrary(pracma)\nlibrary(mvtnorm)\nlibrary(stargazer)\nlibrary(ivreg)\nlibrary(AER)\nlibrary(broom)\nlibrary(wooldridge)\n```\n\nOur first departure from the classical linear model $\\mathcal P_\\text{LM}$ will come in the form of dropping the assumption that $\\E{\\X'\\ep} = \\zer$, i.e our regressors are endogenous. This situation is rather serious, as it prevents the linear model from being identified. Furthermore, the problem is common in applications. There are three main sources of endogeneity:\n\n1. Omitted variables\n2. Measurement error\n3. Simultaneity \n\nFor now we'll consider the first two, and discuss the third on in Section \\@ref(endogeniety-ii-simultaneous-equation-models). Fortunately, we can address endogeneity with the instrumental variables estimator (a special case of which is the two-stage least squares estimator).\n\n## Omitted Variables and Measurement Error\n\n:::{#exm-ex1}\nRecall the Example \\@ref(exm:endogex) where we considered a model relating income to education and other determinants of salary. Suppose the true model is \n$$ \\log(income_i) = \\beta_1 + \\beta_2\\cdot educ_i + \\beta_3 \\cdot experiance_i + \\varepsilon_i,$$ where $\\varepsilon_i$ are the unobserved factors impacting salary, $educ_i$ measure years of post-secondary education, $experiance_i$ measures years of work experience, and $\\cov{educ, experiance} < 0$ (the longer you go to school, the less work experience you tend to have). Now suppose we incorrectly specify the model $$ \\log(income_i) = \\gamma_1 + \\gamma_2\\cdot educ_i + u_i,$$ where $u_i$ are all other factors impacting salary. We've omitted $experiance_i$ as a regressor, so it's implicitly included in $u_i$:\n$$ u_i =  \\beta_3 \\cdot experiance_i + \\varepsilon_i.$$ We no longer satisfy the assumption $\\E{\\X'\\ep} = \\zer$, as $\\cov{educ_i, u_i} \\neq 0$ because $\\cov{educ, experiance} < 0$. What happens if we go ahead and attempt to estimate $\\beta_1$ and $\\beta_2$ anyway? Set $\\bet = [1,3,2]'$, and $\\varepsilon_i \\iid N(0,1)$. \n\n```{r}\n#| warning: false\n\nsource(\"functions/sim_linear_model.r\")\n\nmu <- c(4,10)\nSigma <- matrix(c(2, -0.5, -0.5, 5), nrow = 2)\n\nresults <- sim_linear_model(\n  beta = c(1, 3, 2),\n  n = 1000,\n  dist_vec = c(rmvnorm, rnorm),\n  dist_params_list = list(list(mu, Sigma), list(0, 1))\n)\n\nmodel <- lm(y ~ x2, data = results$observed_data) %>% \n  tidy()\n```\n\n```{r}\n#| echo: false\nmodel %>% \n  knitr::kable()\n```\n\nThe true parameters don't even fall within the 95% confidence intervals centered at our estimates.\n:::\n\nIn general, suppose $$\\Y = [\\Xm,\\Zm][\\bet, \\boldsymbol \\delta]' + \\ep = \\Xm\\bet + \\Zm\\boldsymbol \\delta + \\ep,$$ where we attempt to estimate $\\bet$ via $\\OLS$ despite omitting regressors $\\mathbf Z$ from our model, and all our Gauss-Markov assumptions are met. Note that $\\bet$ is still identified, as $\\E{\\X'\\ep} = \\zer$.\n\\begin{align*}\n\\OLSOV & = (\\Xm'\\Xm)^{-1}\\Xm'\\Y\\\\\n& = (\\Xm'\\Xm)^{-1}\\Xm'(\\Xm\\bet + \\Zm\\boldsymbol \\delta + \\ep)\\\\\n& = \\bet + (\\Xm'\\Xm)^{-1}\\Xm'\\Zm\\boldsymbol\\delta  + (\\Xm'\\Xm)^{-1}\\Xm'\\ep.\n\\end{align*}\nOur estimator is now inconsistent: \n\\begin{align*}\n\\plim \\OLSOV & = \\bet + \\plim\\left[(\\Xm'\\Xm)^{-1}\\Xm'\\Zm\\boldsymbol\\delta\\right] + \\plim\\left[(\\Xm'\\Xm)^{-1}\\right]\\underbrace{\\plim\\left[\\Xm'\\ep\\right]}_\\zer\\\\\n& =  \\bet + \\plim\\left[(\\Xm'\\Xm)^{-1}\\Xm'\\Zm\\boldsymbol\\delta\\right].\n\\end{align*}\n\nThis phenomenon is referred to as **_omitted variable bias (OVB)_**. The use of the word \"bias\" here is a bit misleading, but follows from an interpretation of inconsistency as a persistent bias despite $n\\to\\infty$\n\n:::{#exm-}\n\n## OVB with a Simple Linear Model\n\nSuppose our linear model is $Y = \\alpha + \\beta X+ \\gamma Z + \\varepsilon$, and we attempt to estimate $(\\beta_0,\\beta_1)$ with $\\OLSOV$. In this case,\n\\begin{align*}\n\\hat \\beta_\\text{OLS,OV} & =\\frac{\\sum_{i=1}^n (X_i -\\bar X)(Y_i - \\bar Y)}{\\sum_{i=1}^n (X_i -\\bar X)^2}\\\\ & = \\frac{\\sum_{i=1}^n (X_i -\\bar X)[(\\alpha + \\beta X+ \\gamma Z + \\varepsilon) - \\bar Y]}{\\sum_{i=1}^n (X_i -\\bar X)^2}\\\\ & = \\beta + \\frac{\\sum_{i=1}^n (X_i -\\bar X)(Z_i - \\bar Z)}{\\sum_{i=1}^n (X_i -\\bar X)^2}\\\\ & = \\beta + \\gamma \\cdot \\frac{\\sum_{i=1}^n (X_i -\\bar X)(Z_i-\\bar Z)}{\\sum_{i=1}^n (X_i -\\bar X)^2}.\n\\end{align*}\nThe expectation of this is\n$$\\hat\\beta_\\text{OLS,OV} \\pto \\beta + \\gamma \\cdot \\plim\\frac{n^{-1}\\sum_{i=1}^n (X_i -\\bar X)(Z_i-\\bar Z)}{n^{-1}\\sum_{i=1}^n (X_i -\\bar X)^2} =\\bet + \\gamma \\frac{\\cov{X,Z}}{\\var{X}} .$$\n\nIf we let $\\alpha = 1$, $\\beta = 2$, $\\gamma = 3$, and $\\var{X} = 1$, then $$\\plim \\hat\\beta_\\text{OLS,OV} = 2 + 3\\cov{X,Z}.$$ If we simulate this estimator for different values of $\\cov{X,Z}$, taking $n$ to be very large, then we should see our estimates approximately follow the line $2 + 3\\cov{X,Z}$ when plotted against $\\cov{X,Z}$.\n\n\n\n\n```{r}\niter <- function(cov_xz, var_x, var_z, beta, gamma, n, mu){\n  Sigma <- matrix(c(var_x, cov_xz, cov_xz, var_z), nrow = 2)\n  results <- sim_linear_model(\n    beta = c(1, beta, gamma),\n    n = n,\n    dist_vec = c(rmvnorm, rnorm),\n    dist_params_list = list(list(mu, Sigma), list(0, 1))\n  )\n  output <- lm(y ~ x2, data = results$observed_data) %>% \n    tidy() %>% \n    filter(term == 'x2') %>% \n    select(estimate) %>% \n    mutate(cov_xz = cov_xz)\n  return(output)\n}\n\n\nsim <- function(cov_xz_vals, var_x, var_z, beta, gamma, n, mu){\n  output <- cov_xz_vals %>% \n    map(iter, var_x = var_x, var_z = var_z, beta = beta, gamma = gamma, n = n, mu = mu) %>% \n    bind_rows\n  return(output)\n}\n\nresults <- sim(-1 + (1:100)/50, 1, 1, 2, 3, 1e6, c(4,10))\n\n```\n\n```{r}\n#| code-fold: true\n#| fig-align: center\n#| label: fig-plot701\n#| warning: false\n#| message: false\n#| fig-asp: 0.7\n#| fig-width: 8\n#| fig-cap: \" f\"\n#| code-summary: \"Show code which generates figure\"\n\nresults %>% \n  ggplot(aes(cov_xz, estimate)) + \n  geom_point(size = 0.5) + \n  labs(x = \"Cov(X,Z)\", y = \"Estimated β\") + \n  theme_minimal() \n```\n\n\n:::\n\nWhat happens if instead of omitting a variable from a model, our variables happen to be prone to some degree of measurement error? This is a common scenario in the social sciences where collected data is subject to human error, rounding errors, etc. Suppose a true linear model is specified as $\\Y = \\Xm^*\\bet + \\ep$ for regressors $\\X^*$ where $\\E{\\X^{*\\prime}\\ep} = \\zer$. Much like how we do not observe realizations of $\\ep$, we do not observe realizations of $\\X^*$, instead observing  $\\X = \\X^* + \\mathbf u$ where $\\mathbf u$ corresponds to **_measurement error_**. We'll assume that this measurement error is independent of $\\ep$, independent of $\\X^*$, and is mean zero.^[Are there situations where these assumptions may not hold?] Our model can be rewritten as \n$$ \\Y = \\Xm^*\\bet + \\ep = (\\X - \\mathbf u)\\bet + \\ep = \\X\\bet + \\underbrace{(\\ep - \\mathbf u\\bet)}_{\\boldsymbol \\nu}.$$ In this case $$\\E{\\X\\boldsymbol \\nu} = \\E{(\\X^* + \\mathbf u)(\\ep - \\mathbf u\\bet)} = -\\bet\\E{\\mathbf u'\\mathbf u} = -\\bet \\var{\\mathbf u}.$$ Much like in the case of OVB, $\\OLS$ will be inconsistent.\n\n\\begin{align*}\n\\OLSME &= \\bet + (\\Xm'\\Xm)^{-1}\\Xm'\\ep \\\\\n     & = \\bet + (\\Xm'\\Xm)^{-1}\\Xm'(\\ep - \\mathbf u\\bet)\\\\\n     & = \\bet + (\\Xm'\\Xm)^{-1}\\Xm'\\ep - (\\Xm'\\Xm)^{-1}\\Xm'\\mathbf u\\bet\\\\\n\\plim \\OLSME & = \\bet + \\plim  (\\Xm'\\Xm)^{-1}\\Xm'\\ep + \\plim (\\Xm'\\Xm)^{-1}\\Xm'\\mathbf u\\bet\\\\\n  & = \\bet + \\plim (\\Xm'\\Xm)^{-1}\\Xm'\\mathbf u\\bet & (\\plim \\Xm'\\ep = \\zer)\n\\end{align*}\n\nFor $j\\neq 1$ (there won't be measurement error when $j=1$, as this is just the regressor of 1 which gives the intercept) this simplifies to\n\n$$ \\plim \\hat \\beta_{\\text{OLS,ME},j} = \\beta_j \\left(\\frac{\\var{X_j^*}}{\\var{X_j^*} + \\var{u_j^*}}\\right).$$ This phenomenon is known as **_attenuation bias_**. The term in parentheses will always fall in the interval $(0,1)$, so $\\abs{\\plim \\hat \\beta_{\\text{OLS,ME},j}} < \\abs{\\bet_j}$, hence the name attentuation bias. \n\n## An Updated Linear Model, Identification, and the IV estimator\n\nIn general, if $\\E{\\X'\\ep} \\neq \\zer$, then $\\bet$ is not identified for the linear model $\\mathcal P_\\text{LM}$. Estimation is a non-starter in this case. Even if we had the \"perfect\" estimate for $\\bet,$ the parameter may map to multiple elements $P_{\\bet,\\sigma^2}\\in  \\mathcal P_\\text{LM}$, so it is impossible to determine which model value our data was drawn from. If we drop the assumption $\\E{\\X'\\ep} \\neq \\zer$ from the linear model, then we'll need to replace it with some additional assumptions/structure. \n\nWhile $\\E{\\X'\\ep} \\neq \\zer$, *perhaps* it is the case that there exists some other random vector $\\Z$ which does satisfy $\\E{\\Z'\\ep} = \\zer$. Is this helpful -- no. For a given model with some structural error $\\ep$, there are nearly infinite candidates for $\\Z$ which satisfy this. Consider the model $$\\log(income_i) = \\beta_0 + \\beta_1\\cdot educ_i + \\varepsilon_i,$$ where $\\varepsilon$ are unobserved factors impacting income. What are some random variables $Z$ which are uncorrelated with $\\varepsilon$. A ton! Weather during $i$'s tenth birthday, $i$'s first concert, $i$'s favorite flavor of ice cream, etc. There is an endless list of random variables that are so completely irrelevant to someone's income, that they are uncorrelated with $\\varepsilon$. This is why $\\E{\\Z'\\ep} = \\zer$ is sometimes read as \"$\\Z$ is orthogonal to $\\ep$.\" Not only does it hold in the mathematical sense of the word, but it also holds in the colloquial sense of the word meaning \"has nothing to do with.\" What we want is $\\Z$ to also be correlated with $\\X$, such that $\\Z$ is a sort of proxy/surrogate for $\\X$ with no direct impact on $\\Y$. We'll now generalize the linear model to introduce this set of variables $\\Z$ in lieu of the assumption $\\E{\\X'\\ep} \\neq \\zer$.\n\n:::{#def-}\nThe <span style=\"color:red\">**_(linear) instrumental variables (IV) model_**</span> is defined as $\\mathcal P_\\text{IV} = \\{P_{\\bet,\\sigma^2} \\mid \\bet \\in \\mathbb R^{K}, \\sigma^2\\in\\mathbb R\\}$, where \n\\begin{align*}\n\nP_{\\bet,\\sigma^2} &= \\left\\{F_{\\Xm,\\Zm,\\ep} \\middle|  \\begin{matrix}Y= \\Xm\\bet +\\ep, \\ \\E{\\ep'\\ep\\mid \\X}=\\sigma^2\\mathbf I,\\ f_{(\\Xm,\\Zm)}=\\textstyle\\prod_{i=1}^n f_{(\\X_i,\\Z_i)},\\\\ \\text{rank}\\left(\\E{\\Z'\\X}\\right) = K,\\ \\E{\\ep\\mid \\Xm} =\\boldsymbol \\eta,\\  \\E{\\ep\\mid \\Zm} = \\zer,\\ \\E{\\Z'\\X} \\neq \\zer \\end{matrix} \\right\\},\\\\\n\\Xm & = [\\X_1, \\cdots, \\X_j, \\cdots \\X_K] = [\\X_1, \\cdots, \\X_i, \\cdots \\X_n]',\\\\\n\\Zm & = [\\Z_1, \\cdots, \\Z_j, \\cdots \\Z_K] = [\\Z_1, \\cdots, \\Z_i, \\cdots \\Z_n]',\\\\\n\\dim(\\Z) & = \\dim(\\X) = K\\\\\n\\Y & = [Y_1, \\ldots, Y_n].\n\\end{align*}\nWe refer to the random vector $\\Z$ as <span style=\"color:red\">**_instrumental variables (IVs)_**</span>. We have assumed that $\\E{\\ep\\mid \\Zm} = \\zer$, which subsumes the assumption that $\\E{\\Z'\\ep} = \\zer$. The assumption that $\\Z$ is (weakly) exogenous (uncorrelated with $\\ep$) is known as <span style=\"color:red\">**_instrumental validity_**</span>, while the assumption that $\\E{\\X'\\Z} \\neq \\zer$ ($\\Z$ and $\\X$ are correlated) is known as the <span style=\"color:red\">**_relevance condition_**</span>. The assumption that $\\E{\\Z'\\ep} = \\zer$ is also sometimes known as the  <span style=\"color:red\">**_exclusion restriction_**</span> ($\\Z$ is excluded from the determinants of $Y$). Finally, we sometimes refer to $\\text{rank}\\left(\\E{\\Z'\\X}\\right) = K$ as the <span style=\"color:red\">**_rank condition_**</span>.\n:::\n\nInstrumental validity and the relevance condition are usually written as:\n\\begin{align*}\n\\cov{\\Z,\\ep}& = \\zer,\\\\\n\\cov{\\X, \\Z} &\\neq \\zer.\n\\end{align*}\n*Technically*, this is not 100% accurate. The relevance condition is actually a combination of $\\text{rank}\\left(\\E{\\Z'\\X}\\right) = K$ and $\\cov{\\X, \\Z}\\neq \\zer$. As highlighted by @wooldridge2010econometric, the relevance condition is not \"regressors and instruments are uncorrelated\". Instead, it is \"instruments and endogenous regressors are partially correlated holding the exogenous regressors fixed.\" In other words, the linear projection of the instruments onto all regressors has nontrivial coefficients for endogenous regressors. This is equivalent to $\\text{rank}\\left(\\E{\\Z'\\X}\\right) = K$ and $\\cov{\\X, \\Z}\\neq \\zer$.\n\n\nEven if one regressor is endogenous, $\\E{X_j\\ep} \\neq \\zer$ for some $j$, then $\\E{\\X'\\ep} \\neq \\zer$. If this is the case, we can simply define a portion of $\\Z$ to be the exogenous regressors. Formally, if $[X_1,\\ldots, X_J]$ are weakly exogenous while $[X_{J+1}, \\ldots, X_K]$ are endogenous, then define $Z_1 = X_1,\\ldots ,Z_J=X_j$. \n\n:::{#exm-spec1}\n\n## Linear Model as Special Case of IV Model\n\nA special case of the linear IV model is the classical linear model. Just let $\\boldsymbol\\eta = \\zer$ and $\\X = \\Z$. This fact can be written as $\\mathcal P_\\text{LM}\\subset \\mathcal P_\\text{IV}$.\n:::\n\nWhenever we define a new model, we need to make sure our parameters are identified. \n\n:::{#thm-}\n\n## Identification of Linear IV Model\n\nThe linear IV model is identified as a result of the following assumptions: $\\E{\\Z'\\ep} = \\zer$, $\\E{\\X'\\Z} \\neq \\zer$, and $\\text{rank}\\left(\\E{\\Z'\\X}\\right) = K$.\n:::\n\n:::{.proof}\nFirst we will show $\\bet$ is identified. Let $P_{\\bet,\\sigma^2} = P_{\\bet^*,\\sigma^2}$ for two elements of $\\mathcal P_\\text{IV}$, and suppose for a contradiction that $\\bet\\neq\\bet^*$. We can begin by writing $\\bet$:\n\\begin{align*}\n&\\E{\\Z'\\ep} = \\zer\\\\\n\\implies & \\E{\\Z'(Y-\\X\\bet)} = \\zer & (\\ep = (Y-\\X\\bet))\\\\\n\\implies & \\E{\\Z'Y}-\\bet\\E{\\Z'\\X}= \\zer\\\\\n\\implies & \\E{\\Z'Y} = \\bet\\E{\\Z'\\X}\\\\\n\\end{align*}\nBy the definition of $\\mathcal P_\\text{IV}$, the moments $\\E{\\Z'\\X}$ and $\\E{\\Z'Y}$ are the same for the model values $P_{\\bet,\\sigma^2}$ and  $P_{\\bet^*,\\sigma^2}$, so $\\bet^*$ must also satisfy $\\E{\\Z'Y} = \\bet\\E{\\Z'\\X}$. This contradicts the assumption that $\\text{rank}\\left(\\E{\\Z'\\X}\\right) = K$. If $\\bet$ is identified, then $\\sigma^2$ is as well because we can write it in terms of $\\bet$: \n$$ \\E{(\\Y-\\Xm\\bet)'(\\Y-\\Xm\\bet)\\mid \\X}=\\sigma^2\\mathbf I.$$\n<span style=\"color:white\">space</span>\n:::\n\nSo how do we estimate $\\bet$ for the model $\\mathcal P_\\text{IV}$? If it wasn't clear from the examples dealing with OVB and measurement error, the answer is not with $\\OLS$. \n\n:::{#prp-}\n\n## Inconsisteny of OLS\n\nIf $P_{\\bet,\\sigma^2} \\in \\mathcal P_\\text{IV}$, then $\\OLS$ is biased and inconsistent. In particular, \n\\begin{align*}\n\\E{\\OLS\\mid \\X} & = \\bet + (\\Xm'\\Xm)^{-1}\\Xm\\boldsymbol \\eta \\neq \\bet,\\\\\n\\plim \\OLS & = \\bet + \\E{\\X'\\X}^{-1}\\boldsymbol \\gamma \\neq \\bet,\\\\\n\\end{align*}\nwhere $\\E{\\ep\\mid \\Xm} =\\boldsymbol \\eta$ and $\\E{\\X'\\ep} = \\boldsymbol \\gamma$.\n:::\n\n:::{.proof}\n\\begin{align*}\n\\E{\\OLS\\mid \\Xm} & = \\E{\\bet +(\\Xm'\\Xm)^{-1}\\Xm'\\ep \\mid \\Xm}\\\\\n& = \\bet + (\\Xm'\\Xm)^{-1}\\Xm'\\E{\\ep \\mid \\Xm}\\\\\n& = \\bet + (\\Xm'\\Xm)^{-1}\\Xm'\\boldsymbol \\eta\\\\\n\\plim \\OLS & = \\bet + \\plim\\left[\\left(\\frac{1}{n}\\sum_{i=1}^n\\X_i'\\X_i\\right)^{-1}\\left(\\frac{1}{n}\\sum_{i=1}^n\\X_i'\\varepsilon_i\\right)\\right]\\\\\n& = \\bet + \\plim\\left(\\frac{1}{n}\\sum_{i=1}^n\\X_i'\\X_i\\right)^{-1}\\plim \\left(\\frac{1}{n}\\sum_{i=1}^n\\X_i'\\varepsilon_i\\right) & (\\text{Slutsky's Theorem})\\\\\n& = \\bet + \\E{\\X'\\X}^{-1}\\E{\\X'\\ep} & (\\text{LLN})\\\\\n& = \\bet + \\E{\\X'\\X}^{-1}\\boldsymbol \\gamma\n\\end{align*}\n<span style=\"color:white\">space</span>\n:::\n\n:::{#exm-}\nLet's verify that $\\OLS$ is inconsistent. Suppose $\\Xm = (\\mathbf 1, X)$ where $(X,\\varepsilon)\\iid N(\\boldsymbol \\mu, \\Sig)$ for $\\boldsymbol \\mu = [0,1]'$\n$$\\Sig = \\begin{bmatrix}5&2\\\\2&1  \\end{bmatrix}.$$\nWe have\n\\begin{align*}\n\\E{X\\varepsilon} &= \\cov{X,\\varepsilon} + \\underbrace{\\E{X}}_0\\underbrace{\\E{\\varepsilon}}_1 = 2.\n\\end{align*}\nTherefore\n\\begin{align*}\n\\boldsymbol \\gamma &= \\E{\\Xm'\\ep} = \\begin{bmatrix}\\E{1\\ep}\\\\\\E{X\\ep} \\end{bmatrix} = \\begin{bmatrix}1\\\\2 \\end{bmatrix}\n\\end{align*}\n\nIf we draw realizations ```x``` and ```e``` of $(X,\\varepsilon)$, we should find that ```colMeans(X*e)``` should be approximately $[1,2]'$ by the LLN.\n\n```{r}\nsource(\"functions/sim_endog_linear_model.r\")\n\nSigma <- matrix(c(5,2,2,1), nrow = 2)\nmu <- c(0,1)\n\nresults <- sim_endog_linear_model(\n  beta = c(1,2),\n  n = 1e5,\n  dist_vec = c(rmvnorm),\n  dist_params_list = list(list(mu, Sigma))\n)\n\ncolMeans(results$X*results$e)\n```\n\nLet's now calculate $\\plim \\OLS$. \n\\begin{align*}\n\\E{\\X'\\X}^{-1} &= \\begin{bmatrix}\\E{1} & \\E{X} \\\\ \\E{X} & \\E{X^2} \\end{bmatrix}^{-1} = \\begin{bmatrix}1 & 0 \\\\ 0 & \\var{X} \\end{bmatrix}^{-1} = \\begin{bmatrix}1 & 0 \\\\ 0 & 5 \\end{bmatrix}^{-1}  =  \\begin{bmatrix}1 & 0 \\\\ 0 & 0.2 \\end{bmatrix}\\\\\n\\plim \\OLS & = \\bet + \\E{\\X'\\X}^{-1}\\boldsymbol \\gamma= \\bet + \\begin{bmatrix}1 & 0 \\\\ 0 & 0.2 \\end{bmatrix}\\begin{bmatrix}1\\\\2 \\end{bmatrix}= \\bet + \\begin{bmatrix}1\\\\0.4 \\end{bmatrix}\n\\end{align*}\nIf we let $\\bet = [1,2']$ we should see our estimates converge to $[2, 2.4]'$ as $n\\to\\infty$.\n\n```{r}\niter <- function(k, model){\n  output <- model$observed_data %>% \n    filter(row_number() <= k) %>% \n    lm(formula = y ~ x2, data = .) %>% \n    tidy() %>% \n    select(\n      term, \n      estimate\n    ) %>% \n    mutate(sample_size = k) %>%  \n  return(output)\n}\n\nsim <- function(n_vals, n, beta, dist_vec, dist_params_list, t){\n  model <- sim_endog_linear_model(beta, n, dist_vec, dist_params_list)\n  output <- n_vals %>% \n    map(iter, model = model) %>% \n    bind_rows() %>% \n    mutate(iter_num = t) \n  return(output)\n}\n\nouter_sim <- function(N, n_vals, n, beta, dist_vec, dist_params_list){\n  output <- 1:N %>% \n    map(sim, n_vals = n_vals, n = n, beta = beta, dist_vec = dist_vec, dist_params_list = dist_params_list) %>% \n    bind_rows()\n  return(output)\n}\n\nresults <- outer_sim(\n  N = 1e3, \n  n_vals = (1:50)*20, \n  n = 1e3, \n  beta = c(1,2),\n  dist_vec = c(rmvnorm),\n  dist_params_list = list(list(mu, Sigma))\n)\n```\n\n```{r}\n#| code-fold: true\n#| fig-align: center\n#| label: fig-plot702\n#| warning: false\n#| message: false\n#| fig-asp: 0.7\n#| fig-width: 8\n#| fig-cap: \" f\"\n#| code-summary: \"Show code which generates figure\"\n\nresults %>%\n  mutate(\n    `True Value` = case_when(\n      term == \"(Intercept)\" ~ 1,\n      term == \"x2\" ~ 2,\n    ),\n    `Limit` = case_when(\n      term == \"(Intercept)\" ~ 2,\n      term == \"x2\" ~ 2.4,\n    ),\n    term = case_when(\n      term == \"(Intercept)\" ~ \"β1\",\n      term == \"x2\" ~ \"β2\",\n      )\n  ) %>% \n  rename(Estimate = estimate) %>% \n  pivot_longer(!c(term, sample_size, iter_num)) %>% \n  mutate(line_group = paste0(iter_num, name)) %>% \n  ggplot(aes(sample_size, value, color = name)) + \n  geom_line(aes(group = line_group, size = name)) + \n  facet_wrap(~term) +\n  theme_minimal() +\n  labs(x = \"Sample Size, n\", y = \"Estimates\", color =\"\") +\n  scale_color_manual(values = c(\"black\", \"red\", \"blue\")) +\n  scale_size_manual(values = c(0.1, 0.2, 0.2)) +\n  theme(legend.position = \"bottom\") + \n  guides(size=\"none\")\n```\n\n:::\nAn interesting feature of this problem is that our estimator for the intercept term $\\beta_1$ was inconsistent even though the corresponding regressor (the trivial random variable $X_1 = 1$) is exogenous. In general, the inconsistency of $\\OLS$ in the presence of endogeneity is not limited to the parameters associated with endogenous variables, and will impact each parameter $\\beta_j$.  \n\nInstead of using $\\OLS$, we need an estimator which makes use of the exogenous variables $\\Z$. There are several different ways to motivate this estimator, so we'll go over four particularly approaches which reach the same conclusion. \n\n1. For $\\mathcal P_\\text{IV}$ we can write the true population parameter as $\\bet = \\E{\\Z'\\X}^{-1}\\E{\\Z'Y}$. We can appeal to the analogy-principle here just like we did when deriving $\\OLS$. It stands to reason that the estimator defined by the analogous samples will provide consistent estimates of $\\bet$ by the LLN. This estimator is \n$$\\hat {\\bet}= \\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\X_i\\right)^{-1}\\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_iY_i\\right) = (\\Zm'\\Xm)^{-1}\\Zm'\\Y.$$\n2. Another way of tackling the problem relates to marginal effects and is presented by @cameron2005microeconometrics. This will be a little informal and is only to build intuition. In an abuse of notation, we'll write marginal effects as $\\frac{\\partial Y}{\\partial \\X}$. Ideally, we want $\\beta_j = \\frac{\\partial Y}{\\partial X_j}$ for each $j$. This way, when we estimate $\\bet$, we estimate the marginal effect of $\\X$ on $Y$. Unfortunately, we cannot estimate this directly with $\\X$ as \n$$ \\frac{\\partial Y}{\\partial X_j} = \\beta_j + \\frac{\\partial \\varepsilon}{\\partial X_j} \\implies \\beta_j \\neq \\frac{\\partial Y}{\\partial X_j}.$$\nIf we appeal to the chain rule, we can vary $X_j$ via our instruments $\\Z$:\n\\begin{align*}\n&\\frac{\\partial Y}{\\partial \\Z} = \\frac{\\partial Y}{\\partial X_j} \\frac{\\partial X_j}{\\partial \\Z} \\\\\n\\implies & \\frac{\\partial Y}{\\partial X_j} = \\frac{\\partial Y/\\partial \\Z}{\\partial X_j/\\partial \\Z}\n\\end{align*}\nwhere $\\frac{\\partial Y}{\\partial \\Z}$ holds $\\varepsilon$ constant as $\\cov{\\Z, \\ep} = \\zer$. The marginal effects $\\frac{\\partial X_j}{\\partial \\Z}$ and $\\frac{\\partial Y}{\\partial \\Z}$ correspond to the parameters in the linear projection models of $\\Z$ on $X_j$ and $Y$.^[It's important to emphasize that these are linear projections, not structural linear models. There is no structural relationship between $\\Z$ and $X_j$ or $\\Z$ and $Y$! This is really important, and we'll introduce a definition related to this in the context of 2SLS.] These parameters are given by OLS estimates $(\\Zm'\\Zm)^{-1}\\Zm\\X_j$ and $(\\Zm'\\Zm)^{-1}\\Zm\\Y$, respectively, so\n$$ \\hat\\beta_j = \\frac{(\\Zm'\\Zm)^{-1}\\Zm'\\Y}{(\\Zm'\\Zm)^{-1}\\Zm\\X_j}.$$ If we do this for all regressors $\\X$, then \n$$ \\hat{\\bet} = \\frac{(\\Zm'\\Zm)^{-1}\\Zm'\\Y}{(\\Zm'\\Zm)^{-1}\\Zm\\Xm} =  (\\Zm'\\Xm)^{-1}\\Zm'\\Y$$\n3. We can take a graphical approach given by @pearl2009causality with the simple IV model with one endogenous regressor $X$ and one instrument $Z$. Suppose we have $Y = \\beta_1 + \\beta_2 X + \\varepsilon$, where $\\cov{X,\\varepsilon} \\neq 0$, along with $\\cov{Z,X} \\neq 0$ and $\\cov{Z,\\varepsilon} = 0$ for some instrument $Z$. These relationships can be illustrated in the form of a directed acyclic graph (DAG).\n\n```{r}\n#| code-fold: true\n#| fig-align: center\n#| label: fig-plot703\n#| warning: false\n#| message: false\n#| fig-asp: 0.5\n#| fig-width: 1\n#| fig-cap: \" f\"\n#| code-summary: \"Show code which generates figure\"\n\nknitr::include_graphics(\"figures/iv_dag.png\")\n```\n\nWe can think of the paths which illustrate causation as being multiplicative in the sense that $\\cov{Z,X}\\cdot \\beta_2 = \\cov{Z,Y}$, where $\\beta_2$ is a \"conversion rate\" between changes in $X$ via $Z$ and changes in $Y$ via $Z$ (just like the chain rule approach). This implies $\\beta_2 = \\cov{Z,Y}/\\cov{Z,X}$, so \n$$ \\hat\\beta_2 = \\frac{\\widehat{\\text{Cov}}(Z,Y)}{\\widehat{\\text{Cov}}(Z,X)}.$$ This happens to be a special case of $\\hat{\\bet}=  (\\Zm'\\Xm)^{-1}\\Zm'\\Y$.\n\n4. Another approach in the context of the simple linear model takes advantage of a simple substitution. \n$$ \\cov{Y,Z} = \\cov{\\beta_1 + \\beta_2 X + \\varepsilon, Z} = \\underbrace{\\cov{\\beta_1, Z}}_0 + \\beta_2\\cov{X,Z} + \\underbrace{\\cov{Z,\\varepsilon}}_0 = \\beta_2\\cov{X,Z}.$$ This is the same result we arrived at using the DAG.\n\nWith all roads leading to Rome, we can define this estimator. \n\n:::{#def-}\nThe <span style=\"color:red\">**_instrumental variables (IV) estimator_**</span> is defined as \n\\begin{align*}\n\\IV(\\Xm,\\Zm,\\Y)= (\\Zm'\\Xm)^{-1}(\\Zm'\\Y)= \\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\X_i\\right)^{-1}\\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_iY_i\\right)\n\\end{align*} An realization of this estimator (an estimate) is \n\\begin{align*}\n\\hat{\\mathbf b}_\\text{IV} = \\hat{\\bet}_\\text{IV}(\\X,\\Z,\\y) &= (\\Z'\\X)^{-1}(\\Z'\\y)= \\left(\\frac{1}{n}\\sum_{i=1}^n\\z_i'\\z_i\\right)^{-1}\\left(\\frac{1}{n}\\sum_{i=1}^n\\z_iy_i\\right)\n\\end{align*} \nand will exist when the inverse $(\\Z'\\X)^{-1}$ exists.\n:::\n\n:::{#exm-refex}\nSuppose $(X, Z, \\varepsilon) \\sim N(\\boldsymbol \\mu,\\Sig)$ where\n\\begin{align*}\n\\boldsymbol \\mu & = [10,10,0]',\\\\\n\\Sig & = \\begin{bmatrix}20 & 5 & 1\\\\5&20&0\\\\1&0&1 \\end{bmatrix},\n\\end{align*}\nand $Y = 1 + 3X + \\varepsilon$. Let's simulate a sample of size $n=1000$ from this model $P_{\\bet,\\sigma^2} \\in \\mathcal P_\\text{IV}$, and then calculate $\\IV$.\n\n```{r}\nresults <- sim_endog_linear_model(\n  beta = c(1, 3),\n  n = 1000,\n  dist_vec = c(rmvnorm),\n  dist_params_list = list(\n    list(\n      c(10, 10, 0), \n      matrix(c(20,5,1, 5,20,0,1,0,1), nrow = 3)\n    )\n  )\n)\n\n```\n\nWe should confirm that our drawn sample satisfies the assumptions of the IV model. \n\n```{r}\nresults$sim_draws %>% \n  select(-x1, -z1) %>% \n  cov()\n```\n\nNow let's calculate $\\IV$, keeping in mind that $\\Zm$ is comprised of the instrument $Z$ *and* the exogenous random variable $1$ which gives the intercept term. \n\n```{r}\nIV <- function(y, X, Z){\n  K <- ncol(X)\n  if(ncol(Z) != K) {stop(\"K instruments required\")}\n  if(det(t(Z) %*% X) == 0) {stop(\"rank(Z'X) < K\")}\n  \n  output <- tibble(\n    parameter = paste(\"β\", 1:K, \" estimate\", sep = \"\"),\n    estimate = as.numeric(solve(t(Z) %*% X) %*% t(Z) %*% y)\n  )\n\n  return(output)\n}\n\nIV(results$y, results$X, results$Z) %>% \n  knitr::kable()\n```\n\n:::\n\n:::{#exm-spec2}\n\n## OLS is a Special Case of IV\n\nIn Example \\@ref(exm:spec1) we saw that $\\mathcal P_\\text{LM}\\subset\\mathcal P_\\text{IV}$. In the event $P_{\\bet,\\sigma^2} \\in \\mathcal P_\\text{LM}$, i.e $\\Zm = \\Xm$ and , then \n$$ \\IV = (\\Zm'\\Xm)^{-1}(\\Zm'\\Y) = (\\Xm'\\Xm)^{-1}(\\Xm'\\Y) = \\OLS.$$\n:::\n\n## Properties of the IV Estimator\n\nOne of the reasons OLS is so special is because we're able to characterize its finite sample properties with the Gauss-Markov theorem. This is the exception rather than the rule when assessing estimators. In most cases, we can only arrive at tractable results in the form of an estimator's asymptotic properties. Is this the case with $\\IV$? Let's see if $\\IV$ satisfies our \"baseline\" finite sample property of unbiasedness. \n\\begin{align*}\n\\E{\\IV} &= \\E{\\E{\\IV \\mid \\Xm, \\Zm}}\\\\\n        & =  \\E{\\E{(\\Zm'\\Xm)^{-1}(\\Zm'\\Y) \\mid \\Xm, \\Zm}}\\\\\n        &=\\E{\\E{(\\Zm'\\Xm)^{-1}(\\Zm'(\\Xm\\bet + \\ep)) \\mid \\Xm, \\Zm}}\\\\\n        &=\\bet + \\E{(\\Zm'\\Xm)^{-1}\\Zm'\\E{\\ep \\mid \\Xm, \\Zm}}\\\\\n        & \\neq \\bet\n\\end{align*}\nIn general, $\\E{\\ep \\mid \\Xm, \\Zm} \\neq \\zer$, so $\\IV$ has a bias. \n\n:::{#exm-}\n\n## IV Estimator is Biased\n\nReturn to the model from Example \\@ref(exm:refex), but let $n = 10$. If we simulate the bias of $\\IV$ using 10,000 simulations, we can confirm that $\\IV$ is biased.  \n\n```{r}\niter <- function(beta, n, dist_vec, dist_params_list, t){\n  results <- sim_endog_linear_model(beta, n, dist_vec, dist_params_list)\n  output <- IV(results$y, results$X, results$Z) %>%\n    mutate(iter_num = t) %>%\n    cbind(true_value = beta)\n  return(output)\n}\n\nsim <- function(N, beta, n, dist_vec, dist_params_list){\n  output <- 1:N %>%\n    map(iter, beta = beta, n = n, dist_vec = dist_vec, dist_params_list = dist_params_list) %>%\n    bind_rows()\n  return(output)\n}\n\nresults <- sim(\n  N = 1e4,\n  beta = c(1, 3),\n  n = 10,\n  dist_vec = c(rmvnorm),\n  dist_params_list = list(\n    list(\n      c(10, 10, 0),\n      matrix(c(20,5,1, 5,20,0,1,0,1), nrow = 3)\n    )\n  )\n)\n\nresults %>%\n  group_by(parameter) %>%\n  summarize(bias = mean(abs(estimate - true_value)))\n```\n\nOkay, but is this really an issue? In most settings we would have a sample size much larger than $n = 10$. Let's repeat this experiment with $n = 1000$ and see what happens to our estimator's bias.\n\n```{r}\nresults <- sim(\n  N = 1e4,\n  beta = c(1, 3),\n  n = 1e3,\n  dist_vec = c(rmvnorm),\n  dist_params_list = list(\n    list(\n      c(10, 10, 0),\n      matrix(c(20,5,1, 5,20,0,1,0,1), nrow = 3)\n    )\n  )\n)\n\nresults %>%\n  group_by(parameter) %>%\n  summarize(bias = mean(abs(estimate - true_value))) %>% \n  knitr::kable()\n```\n\nThe bias has been reduced dramatically.\n:::\n\nWhile $\\IV$ is biased, it seems as if it is asymptotically unbiased. Instead of proving this directly, we'll actually show that $\\IV$ is root-N CAN, a sufficient condition for asymptotic unbiasedness. Before tackling that, let's prove that $\\IV$ is consistent directly. One of the reasons we opted to not estimate $\\bet$ via $\\OLS$ was that $\\OLS$ is not consistent for $\\mathcal P_\\text{IV}$, so it shouldn't be a surprise that $\\IV$ is consistent. \n\n:::{#prp-}\n\n## IV Estimator is Consistent\n\nIf $P_{\\bet,\\sigma^2}\\in \\mathcal P_\\text{IV}$, then $\\IV\\pto \\bet$.\n:::\n\n:::{.proof}\n\\begin{align*}\n\\IV &= \\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\X_i\\right)^{-1}\\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_iY_i\\right)\\\\\n    & = \\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\X_i\\right)^{-1}\\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i[\\X_i\\bet + \\varepsilon_i]\\right)\\\\\n    & = \\underbrace{\\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\X_i\\right)^{-1}\\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\X_i\\right)}_1\\bet + \\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\X_i\\right)^{-1}\\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\varepsilon_i\\right)\\\\\n    & = \\bet + \\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\X_i\\right)^{-1}\\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\varepsilon_i\\right)\\\\\n\\plim \\IV & = \\bet + \\plim \\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\X_i\\right)^{-1}\\cdot \\plim \\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\varepsilon_i\\right) & (\\text{Slutsky's theorem})\\\\\n& = \\bet + \\plim \\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\X_i\\right)^{-1}\\cdot \\E{\\Z'\\ep} & (\\text{LLN})\\\\\n& = \\bet + \\plim \\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\X_i\\right)^{-1}\\cdot \\zer & (\\E{\\Z'\\ep} = \\zer)\\\\\n& = \\bet\n\\end{align*}\n<span style=\"color:white\">space</span>\n:::\n\n\n\n:::{#thm-}\n\n## IV Estimator is Root-n CAN\n\nIf $P_{\\bet, \\sigma^2} \\in \\mathcal P_\\text{IV}$, then\n$$\\IV \\asim N\\left(\\bet, \\sigma^2\\E{\\Zm'\\Xm}^{-1}\\E{\\Zm'\\Zm}\\E{\\Xm'\\Zm}^{-1}\\right) =  N\\left(\\bet, \\frac{\\sigma^2}{n}\\E{\\Z'\\X}^{-1}\\E{\\Z'\\Z}\\E{\\X'\\Z}^{-1} \\right)$$\n:::\n\n:::{.proof}\nThe proof is almost identical to that of Theorem \\@ref(thm:asymols).\n\n\\begin{align*}\n\\sqrt n(\\IV - \\bet) & = \\sqrt{n}\\left[\\bet + \\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\X_i\\right)^{-1}\\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\varepsilon_i\\right) - \\bet\\right]\\\\\n& = \\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\X_i\\right)^{-1}\\sqrt{n}\\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\varepsilon_i - \\zer \\right)\\\\\n& =\\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\X_i\\right)^{-1}\\sqrt{n}\\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\varepsilon_i - \\E{\\Z_i\\varepsilon_i} \\right) & (\\E{\\Z'\\varepsilon} = \\zer ) \\\\\n& = \\underbrace{\\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\X_i\\right)^{-1}}_{\\pto \\E{\\Z'\\X}^{-1}} \\underbrace{\\sqrt{n}\\left(\\frac{1}{n}\\sum_{i=1}^n\\Z_i'\\varepsilon_i - \\E{\\Z_i\\varepsilon_i} \\right)}_{\\dto N\\left(\\E{\\Z_i\\varepsilon_i}, \\var{\\textstyle \\sum \\X_i\\varepsilon_i}/n\\right)} & (\\text{LLN and CLT})\\\\\n&\\dto \\E{\\Z'\\X}^{-1}\\cdot N\\left(\\E{\\Z_i\\varepsilon_i}, \\var{\\textstyle \\sum \\Z_i\\varepsilon_i}/n\\right) & (\\text{Slutsky's Theorem})\\\\\n& = \\E{\\Z'\\X}^{-1}\\cdot N\\left(\\zer, \\sigma^2\\E{\\Z'\\Z}\\right) \\\\\n& = \\E{\\Z'\\X}^{-1}\\cdot N\\left(\\zer, \\sigma^2\\E{\\Z'\\Z}\\right)\\\\\n& = N\\left(\\zer, \\E{\\Z'\\X}^{-1}\\sigma^2\\E{\\Z'\\Z}\\left[\\E{\\Z'\\X}^{-1}\\right]'\\right)\\\\\n& = N\\left(\\zer, \\E{\\Z'\\X}^{-1}\\sigma^2\\E{\\Z'\\Z}\\E{\\X'\\Z}^{-1}\\right).\n\\end{align*}\nThis implies that \n$$\\IV\\asim N\\left(\\bet, \\frac{\\sigma^2}{n}\\E{\\Z'\\X}^{-1}\\E{\\Z'\\Z}\\E{\\X'\\Z}^{-1} \\right).$$ \nIf desired, we can write the asymptotic variance in terms of matrices $\\Xm$ and $\\Zm$:\n\\begin{align*}\n\\avar{\\IV} & = \\frac{\\sigma^2}{n}\\E{\\Z'\\X}^{-1}\\E{\\Z'\\Z}\\E{\\X'\\Z}^{-1}\\\\\n& = \\frac{\\sigma^2}{n}\\left[\\frac{\\E{\\Zm'\\Xm}}{n}\\right]^{-1}\\left[\\frac{\\E{\\Zm'\\Zm}}{n}\\right]\\left[\\frac{\\E{\\Xm'\\Zm}}{n}\\right]^{-1} \\\\\n& = n^2\\cdot\\frac{1}{n}\\cdot\\frac{\\sigma^2}{n}\\E{\\Zm'\\Xm}^{-1}\\E{\\Zm'\\Zm}\\E{\\Xm'\\Zm}^{-1}\\\\\n& = \\sigma^2\\E{\\Zm'\\Xm}^{-1}\\E{\\Zm'\\Zm}\\E{\\Xm'\\Zm}^{-1}\n\\end{align*}\n<span style=\"color:white\">space</span>\n:::\n\n:::{#cor-}\n\n## IV Estimator is Asymptotically Unbiased\n\nIf $P_{\\bet, \\sigma^2} \\in \\mathcal P_\\text{IV}$, then \n$$ \\lim_{n\\to\\infty}\\text{Bias}(\\IV) = 0.$$\n:::\n\nIn order to appeal to the asymptotic distribution of $\\IV$ to perform inference, we need a consistent estimator of the asymptotic variance. Fortunately, we can take nearly the same exact approach we took with $\\OLS$. \n\n:::{#prp-}\n\n## Estimation of IV Variance\n\nDefine the estimator \n\\begin{align*}\nS^2 &=  \\frac{\\hat{\\e}'\\hat{\\e}}{n-K}\\\\\n\\hat{\\e} &= \\Y - \\Xm\\IV\n\\end{align*} in the context of the linear IV model. Then:\n\n1. $S^2$ is an unbiased for $\\var{\\ep\\mid\\X} = \\sigma^2$.\n2. $S^2$ is a consistent estimator $\\var{\\ep\\mid\\X} = \\sigma^2$.\n3. The estimator $\\widehat{\\text{Avar}}(\\IV) = S^2(\\Zm'\\Xm)^{-1}(\\Zm'\\Zm)(\\Xm'\\Zm)^{-1}$ is a consistent estimator for \n${\\text{Avar}}(\\IV)$.\n:::\n\n:::{.proof}\nThe proof is nearly identical to that of Proposition \\@ref(prp:olsvar).\n:::\n\n:::{#exm-}\n\n## Coding Exercise\n\nR has no base function which implements $\\IV$, so let's write our own. For reference, we can compare our results with those given by ```ivreg()``` from the ```AER``` (applied econometrics in R) package.\n\n```{r}\nIV <- function(y, X, Z){\n  #determine dimensions, perform IV\n  n <- length(y)\n  K <- coalesce(ncol(X), 1)\n  if(coalesce(ncol(Z), 1) != K) {stop(\"K instruments required\")}\n  if(det(t(Z) %*% X) == 0) {stop(\"rank(Z'X) < K\")}\n  \n  hat_beta <- solve(t(Z) %*% X) %*% t(Z) %*% y \n  \n  #use IV estimates to calculate residuals and estimate SEs\n  res <- (y-X %*% hat_beta)\n  S2 <- ((t(res) %*% res)/(n - K)) %>% as.numeric() \n  var_hat <- (S2) *  solve(t(Z) %*% X) %*% (t(Z) %*% Z) %*% solve(t(X) %*% Z) \n  se_hat <- sqrt(diag(var_hat))\n  \n  #t-stat, confidence intervals, p values\n  t <- hat_beta/se_hat\n  lower_CI <- hat_beta - qnorm(0.975)*se_hat\n  upper_CI <- hat_beta + qnorm(0.975)*se_hat\n  p_val <- 2*(1 - pt(t, n-K))\n  \n  #combine everything into one table to return\n  output <- tibble(\n    parameter = paste0(\"β\", 1:K),\n    estimate = hat_beta,\n    std_error = se_hat,\n    t_stat = t,\n    lower_95_CI = lower_CI,\n    upper_95_CI = upper_CI,\n    p_value = p_val\n  )\n  return(output)\n}\n```\n\nLet's estimate the model from Example \\@ref(exm:refex) using ```ivreg()```.\n\n```{r}\nresults <- sim_endog_linear_model(\n  beta = c(1, 3),\n  n = 1000,\n  dist_vec = c(rmvnorm),\n  dist_params_list = list(\n    list(\n      c(10, 10, 0), \n      matrix(c(20,5,1, 5,20,0,1,0,1), nrow = 3)\n    )\n  )\n)\n\nivreg(y ~ x2 | z2, data = results$observed_data) %>% \n  tidy() %>% \n  knitr::kable()\n```\n\nNow we can use our function and verify that the outputs are the same. \n\n```{r}\nIV(results$y, results$X, results$Z) %>% \n  knitr::kable()\n```\n:::\n\n:::{#exm-}\n\n## Intuition behind Asymptotic Variance\n\nIn Example \\@ref(exm:csvarols) we provided some intuition as to how $\\var{\\OLS} = \\frac{\\sigma^2}{n} \\E{\\X'\\X}^{-1}$ changed in response to changes in $\\sigma^2$, $n$, and components of $\\E{\\X'\\X}$. The variance of $\\OLS$ is smaller for large samples and when the error term $\\ep$ has a small variance. The more variance we have in our regressors (which is related to $\\E{\\X'\\X}^{-1}$), the more efficient our estimator. So what is the intuition behind $\\avar{\\IV} =\\frac{\\sigma^2}{n}\\E{\\Z'\\X}^{-1}\\E{\\Z'\\Z}\\E{\\X'\\Z}^{-1}$? Three things should look familiar. The variance increases with increases in $\\sigma^2$ and decreases with increases in $n$. Consider the model $Y = X\\beta + \\varepsilon$ when we instrument for $X$ with $Z$, such that \n$$\\avar{\\IV} =\\frac{\\sigma^2}{n}\\frac{\\E{Z^2}}{\\E{ZX}^2} = \\frac{\\var{Z} + \\E{Z}^2}{[\\cov{X,Z} + \\E{Z}\\E{X}]^2}.$$ Holding the average of $Z$ and $X$ fixed, we see that the asymptotic variance of our estimator increases with linearly with $\\var{Z}$, and decreases quadratically as $\\cov{X,Z}$. The latter of these facts shouldn't be surprising. The larger $\\cov{X,Z}$, the more relevant (\"stronger\") our instrument $Z$ is, and the better our estimates. If we simplify this example even further by assuming $\\E{X}=\\E{Z}=0$ and $\\var{X} = \\var{Z}=1$, then\n$$\\avar{\\IV} = \\frac{1}{\\cov{X,Z}^2} = \\left(\\frac{\\cov{X,Z}}{1\\cdot 1} \\right)^{-2} = \\left(\\frac{\\cov{X,Z}}{\\sigma_Y\\cdot \\sigma_X} \\right)^{-2} = \\rho_{X,Z}^{-2}.$$\nThe asympotitc variance of our estimator is inversely proportional to the correlation of $X$ and $Z$. \n\n:::\n\n## Many Instruments, 2SLS\n\nWhen defining $\\mathcal P_\\text{IV}$, we assumed $\\dim(\\Z) = \\dim(\\X) = K$. What happens if we have $L = \\dim(\\Z) > \\dim(\\X) = K$? Let's consider a special case first.\n\n\n:::{#exm-ref3}\n\n## OLS vs. IV\n\nConsider a model $\\Y = \\Xm \\bet + \\ep$ which satisfies the Gauss-Markov assumption, *but* also specifies the existence of $K$ separate instrumental variables $\\Z$. In other words, we have $2K$ instruments in the form of $\\X$ and $\\Z$. Should we estimate $\\bet$ via OLS (equivalent to IV using $\\X$ as instruments for $\\X$), or should we estimate $\\bet$ via IV using $\\Z$? It may be tempting to pick the latter. What if we are confident that $\\Z$ are valid instruments, but aren't positive that $\\X$ is exogenous. If we estimated $\\bet$ with $\\IV = (\\Zm'\\Xm)^{-1}\\Zm'\\Y$, then we would be playing it safe and not risk inconsistent estimates via $\\IV'=(\\Xm'\\Xm)^{-1}\\Xm'\\Y = \\OLS$. Unfortunately this approach has a cost in the form of variance/standard errors. \n\\begin{align*}\n\\text{Avar}(\\IV) &= \\sigma^2\\E{\\Zm'\\Xm}^{-1}\\E{\\Zm'\\Zm}\\E{\\Xm'\\Zm}^{-1}\\\\\n\\text{Avar}(\\IV') &= \\text{Avar}(\\OLS) = \\sigma^2\\E{\\Xm'\\Xm}^{-1} & (\\Xm = \\Zm)\n\\end{align*}\nThe difference $\\text{Avar}(\\IV) - \\text{Avar}(\\OLS)$ is PSD, so \n$$ \\se{\\hat\\beta_{\\text{IV},j}'} = \\se{\\hat\\beta_{\\text{OLS},j}} < \\se{\\hat\\beta_{\\text{IV},j}}.$$\nAs the next simulation shows, this difference can be fairly large.\n\n```{r}\niter <- function(beta, n, dist_vec, dist_params_list, t){\n  model <- sim_endog_linear_model(beta, n, dist_vec, dist_params_list)\n  \n  OLS_results <- IV(model$y, model$X, model$X) %>% \n    select(\n      parameter, \n      estimate\n    ) %>% \n    mutate(estimator = \"OLS\")\n  \n  IV_results <- IV(model$y, model$X, model$Z) %>% \n    select(\n      parameter, \n      estimate\n    ) %>% \n    mutate(estimator = \"IV\")\n  \n  output <- OLS_results %>% \n    bind_rows(IV_results) %>% \n    mutate(iter_num = t)\n  \n  return(output)\n}\n\nsim <- function(N, beta, n, dist_vec, dist_params_list){\n  output <- 1:N %>% \n    map(iter, beta = beta, n = n, dist_vec = dist_vec, dist_params_list = dist_params_list) %>% \n    bind_rows()\n  return(output)\n}\n\nresults <- sim(\n  N = 1e5,\n  beta = c(0, 0),\n  n = 100,\n  dist_vec = c(rmvnorm),\n  dist_params_list = list(\n    list(\n      c(1, 10, 0), \n      matrix(c(20,5,0, 5,20,0,0,0,1), nrow = 3)\n    )\n  )\n) \n```\n\n```{r}\n#| code-fold: true\n#| fig-align: center\n#| label: fig-plot704\n#| warning: false\n#| message: false\n#| fig-asp: 0.7\n#| fig-width: 8\n#| fig-cap: \" f\"\n#| code-summary: \"Show code which generates figure\"\n\nresults %>% \n  ggplot(aes(estimate)) + \n  geom_histogram(aes(y = ..density..), bins = 70, fill = \"white\", color = \"black\") + \n  facet_grid(vars(estimator), vars(parameter)) +\n  theme_minimal() + \n  xlim(-0.5,0.5) +\n  labs(x = \"Estimates\", y = \"Density\")\n```\n\nIf we calculate the simulated standard errors of our estimators, we find that using $\\IV$ results in nearly a four fold decrease in standard error.\n\n```{r}\n#| warning: false\n\nresults %>% \n  group_by(estimator, parameter) %>% \n  summarize(std = sd(estimate)) %>% \n  ungroup() %>% \n  pivot_wider(names_from = parameter, values_from = std) %>% \n  knitr::kable()\n```\n:::\n\n:::{#exm-ex4}\n\n## IV vs... IV?\n\nSuppose $Y = X + \\varepsilon$ for an endogenous $X$. Fortunately, we have two instruments $Z_1$ and $Z_2$. Which instrument do we use to estimate $\\beta = 1$. At first the answer seems simple -- just estimate the model using each instrument separately, and then pick the estimates with the lower standard error. \n```{r}\ncompare_two_ivs <- function(beta, n, dist_vec, dist_params_list){\n  model <- sim_endog_linear_model(beta, n, dist_vec, dist_params_list)\n  # Exclude intercepts \n  first_iv <- IV(model$y, model$X[,-1], model$Z[,2]) %>% \n    select(\n      parameter,\n      std_error\n    ) %>% \n    mutate(\n      instrument = \"Z1\",\n      parameter = \"β\")\n  # Exclude intercepts \n  second_iv <- IV(model$y, model$X[,-1], model$Z[,3]) %>% \n    select(\n      parameter,\n      std_error\n    ) %>% \n    mutate(\n      instrument = \"Z2\",\n      parameter = \"β\")\n  output <- bind_rows(first_iv, second_iv)\n  return(output)\n}\n\n\ncompare_two_ivs(\n  beta = c(0,1),\n  n = 50,\n  dist_vec = c(rmvnorm),\n  dist_params_list = list(\n    list(\n      c(0, 0, 0, 0),\n      matrix(c(1, 0.5, 0.5, 0.5, 0.5, 1, 0.3, 0, 0.5, 0.3, 1, 0,0.5, 0, 0, 1), nrow = 4)\n    )\n  )\n) %>%\n  knitr::kable()\n```\n\nSo we should use the instrument $Z_2$! Or are we forgetting some other instruments? Consider $Z_3 = aZ_1 + bZ_2$. \n\\begin{align*}\n\\E{Z_3\\varepsilon} & = \\E{(aZ_1 + bZ_2)\\varepsilon} = a\\underbrace{\\E{Z_1\\varepsilon}}_0 + b\\underbrace{\\E{Z_2\\varepsilon}}_0 = 0\\\\\n\\E{Z_3X} & = \\E{(aZ_1 + bZ_2)X} = a\\underbrace{\\E{Z_1X}}_{\\neq 0} + b\\underbrace{\\E{Z_2X}}_{\\neq 0} \\neq 0\n\\end{align*}\nIt turns out that *any* linear combination of instruments is a valid instrument. There are an infinite number of candidates for instruments, so what do we do? Let's simulate some standard errors and see if we can notice patterns between them and the choice of instruments. We'll restrict our attention to instruments in the set $\\{aZ_1 + (1-a)Z_2\\mid a\\in\\R\\}$ to simplify visualizations. We will calculate the $\\var{\\IV \\mid \\Xm,\\ \\Zm}$ for a fixed sample drawn from $(X,Z_1,Z_2,\\varepsilon)\\iid N(\\boldsymbol \\mu, \\Sig)$ where\n\n\\begin{align*}\n\\boldsymbol \\mu & = [0,0,0,0]',\\\\\n\\Sig & = \\begin{bmatrix}1 & 0.5 & 0.5 & 0.5\\\\0.5&1&0.3&0\\\\0.5&0.3&1&0\\\\0.5&0&0&1 \\end{bmatrix}.\n\\end{align*}\n\n```{r}\niter <- function(model, a){\n  model$Z[,2] <- a*model$Z[,2] + (1-a)*model$Z[,3]\n  output <- IV(model$y, model$X[,-1], model$Z[,2]) %>% \n    select(\n      parameter,\n      std_error\n    ) %>% \n    mutate(a = a)\n  return(output)\n}\n\nsim <- function(a_vals, beta, n, dist_vec, dist_params_list){\n  model <- sim_endog_linear_model(beta, n, dist_vec, dist_params_list)\n  output <- a_vals %>% \n    map(iter, model = model) %>% \n    bind_rows()\n  return(output)\n}\n\nresults <- sim(\n  a_vals = seq(-2, 2, length = 500),\n  beta = c(0,1),\n  n = 50,\n  dist_vec = c(rmvnorm),\n  dist_params_list = list(\n    list(\n      c(0, 0, 0, 0),\n      matrix(c(1, 0.5, 0.5, 0.5, 0.5, 1, 0.3, 0, 0.5, 0.3, 1, 0,0.5, 0, 0, 1), nrow = 4)\n    )\n  )\n)\n```\n\n\n```{r}\n#| code-fold: true\n#| fig-align: center\n#| label: fig-plot705\n#| warning: false\n#| message: false\n#| fig-asp: 0.7\n#| fig-width: 8\n#| fig-cap: \" f\"\n#| code-summary: \"Show code which generates figure\"\nresults %>% \n  ggplot(aes(a, std_error)) +\n  geom_line() + \n  theme_minimal() +\n  labs(x = \"a\", y = \"Standard Error of IV Estimator with Z = a*Z1+(1-a)Z2\")\n```\n\nCertain linear combinations have lower standard errors than others, so we'll need to think of some method of finding the best possible instruments given a set. \n:::\n\nBefore considering this problem in general, let's extend the IV model to allow for more instruments than regressors. \n\n:::{#def-}\nThe <span style=\"color:red\">**_(linear) instrumental variables (IV) model_**</span> is defined as $\\mathcal P_\\text{IV} = \\{P_{\\bet,\\sigma^2} \\mid \\bet \\in \\mathbb R^{K}, \\sigma^2\\in\\mathbb R\\}$, where \n\\begin{align*}\nP_{\\bet,\\sigma^2} &= \\{F_{\\Xm,\\Zm,\\ep} \\mid\\ \\text{rank}\\left(\\E{\\Z'\\Z}\\right) = L,\\ \\text{rank}\\left(\\E{\\Z'\\X}\\right) = K, \\ldots  \\},\\\\\n\\Xm & = [\\X_1, \\cdots, \\X_j, \\cdots \\X_K] = [\\X_1, \\cdots, \\X_i, \\cdots \\X_n]',\\\\\n\\Zm & = [\\Z_1, \\cdots, \\Z_j, \\cdots \\Z_L] = [\\Z_1, \\cdots, \\Z_i, \\cdots \\Z_n]',\\\\\n\\dim(\\Z) & = L,\\\\ \n\\dim(\\X) &= K,\\\\\n\\Y & = [Y_1, \\ldots, Y_n].\n\\end{align*}\nA necessary condition for the rank condition $\\text{rank}\\left(\\E{\\Z'\\X}\\right) = K$ is the <span style=\"color:red\">**_order condition_**</span>, $L\\ge K$. In the event $L = K$ we say the model is <span style=\"color:red\">**_exactly identified_**</span>. If $L > K$, the model is <span style=\"color:red\">**_over-identified_**</span>.\n:::\n\nWhen $L=K$ this is just the original IV model, and we know how to estimate this with $\\IV$. In the event $L > K$, the model is still identified, as we haven't modified the identifying assumptions that $\\E{\\Z'\\ep} = \\zer$, $\\E{\\X'\\Z} \\neq \\zer$, and $\\text{rank}\\left(\\E{\\Z'\\X}\\right) = K$. In fact, our model would still be identified if we discarded $L - K$ instruments! This is where the term \"over-identified\" comes from, and as far as \"problems\" go, it's not a bad problem to have. We have so many instruments, that we have an infinite number of ways to estimate the model! \n\nIn general, any linear combination of instruments $Z_1,\\ldots, Z_L$ is also an instrument. We can only use $K$ instruments with the estimator $\\IV$, so we want to find the $K$ linear combinations of our instruments (some of which could reduce to a single $Z_j$) which give us the most efficient estimator. The $K$ linear combinations of the $L$ instruments can be expressed as a $L\\times K$ matrix $\\F$ which gives instruments $\\Z\\F$. If we elect to use the new instruments $\\Z\\F$, the IV estimator becomes $$\\IV = [(\\Zm\\F)'\\Xm]^{-1}[(\\Zm\\F)'\\Y].$$ The problem of selecting $\\F$ such that we maximize the efficiency of $\\IV$ is given as:  \n$$\\argmin_{\\F}\\ \\text{Avar}(\\IV) = \\argmin_{\\F}\\ \\sigma^2\\E{(\\Zm\\F)'\\Xm}^{-1}\\E{(\\Zm\\F)'(\\Zm\\F)}\\E{\\Xm'(\\Zm\\F)}^{-1}.$$ Solving this looks like a miserable time, so let's stop appealing directly to math and consider what we're *actually* doing here. We're looking for the \"best\" instruments. It stands to reason that \"good\" instruments will be those that have more explanatory power with respect to the endogenous regressors $\\X$ than others. So given draws of $(\\Z,\\X)$, how can we determine the best way to predict/explain $\\X$ given $\\Y$ --- by estimating the linear projection associated with $(\\Z,\\X)$ via OLS! For each $j = 1,\\ldots,K$ we have \n\\begin{align*}\n\\OLS^j &= (\\Zm'\\Zm)^{-1}\\Zm'\\X_j & (j = 1,\\ldots, K)\n\\end{align*} where $\\OLS^j$ define the instrument formed from linear combinations of $Z_1,\\ldots, Z_L$ which has the most predictive power for $X_j$:\n\\begin{align*}\n\\hat X_j &= \\Z \\OLS^j = \\hat\\beta_1^jZ_1 + \\hat\\beta_2^jZ_2 + \\cdots + \\hat\\beta_L^jZ_L & (j = 1,\\ldots, K)\n\\end{align*}\nWritten compactly using matrices, we have \n\\begin{align*}\n\\hat{\\X} &=  \\Z(\\Zm'\\Zm)^{-1}\\Zm'\\Xm,\\\\\n\\hat{\\Xm} &=  \\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm,\n\\end{align*}\nwhere $\\hat{\\X}$ is a random vector of instruments, and $\\hat{\\Xm}$ is $n$ random vectors $\\hat{\\X}$ \"stacked\" to form a random matrix. If we elect to use these instruments to estimate our model, then \n$$ \\IV = [(\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm)'\\Xm]^{-1}[(\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm)'\\Y].$$\nThis estimator is a special case of $\\IV$ where we have determined the $K$ instruments via linear projection, and is known as two-stage least squares.\n\n:::{#def-}\nThe <span style=\"color:red\">**_two-stage least squares (2SLS) estimator_**</span> is defined as \n\\begin{align*}\n\\TSLS(\\Xm, \\Zm, \\Y) &= [\\Xm'\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm]^{-1}\\Xm'\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Y= [\\hat{\\Xm}'\\Xm]^{-1}\\hat{\\Xm}'\\Y,\\\\\n                 \\hat{\\Xm} &=  \\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm.   \n\\end{align*}\nCalculating $\\hat{\\Xm}$ via OLS is referred to as the <span style=\"color:red\">**_first stage_**</span>, while calculating $\\IV$ using $\\hat{\\Xm}$ is the <span style=\"color:red\">**_second stage_**</span>. It can be useful to define the projection matrix associated with the first stage, \n\\begin{align*}\n\\mathbb P_{\\Zm} &= \\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\\\\n \\hat{\\Xm} & = \\mathbb P_{\\Zm}\\Xm.\n\\end{align*}\n:::\n\nThe name \"two-stage least squares\" can be a bit misleading depending on how it is presented. It's very common to think of each stage of 2SLS as an application of OLS. In the first stage we perform OLS to calculate the instruments $\\hat{\\X}$, and then regress $Y$ on $\\hat{\\X}$ via OLS in the second stage. At first these seems at odds with our definition, because the second stage relies on the IV estimator, but it is equivalent in a sense. We'll explore this in depth in Example \\@ref(exm:se).\n\n:::{#exm-}\n\n## OLS as 2SLS\n\nConsider the situation from Example \\@ref(exm:ref3) where $\\X$ is comprised of entirely exogenous regressors. In this case our vector of instruments is actually a $L+K$ vector $[\\X,\\Z]$. Instead of directly calculating\n\\begin{align*}\n\\hat{\\Xm} &= [\\Xm, \\Zm]([\\Xm, \\Zm]'[\\Xm, \\Zm])^{-1}[\\Xm, \\Zm]'\\Xm,\\\\\n\\end{align*}\nwe can intuit the result of the first stage. If we regress $X_j$ on $X_1,\\ldots, X_j,\\ldots,Z_1,\\ldots,Z_L$, then all coefficients should be zero except that associated with the independent variable $X_j$ which will be 1. Therefore the OLS estimates from stage one should be a $L \\times K$ matrix where the first $K$ rows are a diagonal matrix of $1$'s and the bottom $L - K$ rows are 0. If we multiply $[\\Xm, \\Zm]$ by this, then we have \n$$ \\hat{\\Xm} = \\mathbf 1\\Xm + \\zer \\Zm = \\Xm.$$\nThis gives \n$$ \\TSLS = [\\hat{\\Xm}'\\Xm]^{-1}\\hat{\\Xm}'\\Y = [{\\Xm}'\\Xm]^{-1}{\\Xm}'\\Y = \\OLS.$$\n:::\n\n:::{#exm-}\n\n## Exactly Identified Case\n\nIn the event that $L = K$, there is no \n:::\n\nBecause $\\TSLS$ is just a special case of $\\IV$ using instruments $\\hat{\\Xm}$, the properties of $\\TSLS$ follow directly from those of $\\IV$. \n\n:::{#thm-}\n\n## IV Estimator is Root-n CAN\n\nIf $P_{\\bet, \\sigma^2} \\in \\mathcal P_\\text{IV}$, then $\\TSLS \\pto \\bet$ and \n$$\\TSLS \\asim N\\left(\\bet, \\sigma^2\\E{\\hat{\\Xm}'\\hat{\\Xm}}^{-1}\\right) =  N\\left(\\bet, \\frac{\\sigma^2}{n}\\E{\\hat{\\X}'\\hat{\\X}}^{-1}\\right).$$ \n:::\n\n:::{.proof}\nWe know that $\\TSLS$ is Root-n CAN because $\\IV$ is. All we need to show is that the asymptotic variance simplifies to the given expression when using instruments $\\hat{\\X}$.\n\\begin{align*}\n\\text{Avar}(\\TSLS) &= \\sigma^2\\E{\\hat{\\Xm}\\Xm}^{-1}\\E{\\hat{\\Xm}\\hat{\\Xm}}\\E{\\Xm'\\hat{\\Xm}}^{-1}\\\\\n& = \\sigma^2\\E{[\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm]'\\Xm}^{-1}\\E{[\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm]'[\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm]}\\E{\\Xm'[\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm]}^{-1}\\\\\n& = \\sigma^2\\E{\\Xm'\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm}^{-1}\\text{E}[\\Xm'\\Zm\\underbrace{(\\Zm'\\Zm)^{-1}\\Zm'\\Zm}_{\\mathbf I}(\\Zm'\\Zm)^{-1}\\Zm'\\Xm]\\E{\\Xm'\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm}^{-1}\\\\\n & = \\sigma^2\\text{E}[\\Xm'\\underbrace{\\Zm\\Zm^{-1}}_{\\mathbf I}\\underbrace{(\\Zm')^{-1}\\Zm'}_{\\mathbf I}\\Xm]^{-1}\\text{E}[\\Xm'\\underbrace{\\Zm\\Zm^{-1}}_{\\mathbf I}\\underbrace{(\\Zm')^{-1}\\Zm'}_{\\mathbf I}\\Xm]\\E{\\Xm'\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm}^{-1}\\\\\n & = \\sigma^2\\underbrace{\\text{E}[\\Xm'\\Xm]^{-1}\\text{E}[\\Xm'\\Xm]}_{\\mathbf I}\\E{\\Xm'\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm}^{-1}\\\\\n & = \\sigma^2\\E{\\Xm'[\\Zm(\\Zm'\\Zm)^{-1}\\Zm']'\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm}^{-1} & (\\Zm (\\Zm'\\Zm)^{-1}\\Zm'\\text{ sym. and idem.}) \\\\\n & = \\sigma^2\\E{[\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm]'[\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm]}^{-1}\\\\\n& = \\sigma^2\\E{\\hat{\\Xm}'\\hat{\\Xm}}^{-1} & (\\hat{\\Xm} = \\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm)\n\\end{align*}\n:::\n\nThe motivation for introducing $\\TSLS$ was not all choices of instruments being equal with respect to efficiency, and perhaps the instruments which result from projecting $\\X$ onto $\\Z$ result in an IV estimator which is more efficient than most others. This IV estimator is not just more efficient that most others, it is *the* most efficient IV estimator. The proof of this is adapted from @wooldridge2010econometric.  \n\n\n:::{#thm-eff2}\n\n## 2SLS is Asymptotically Efficient\n\nIf $P_{\\bet, \\sigma^2} \\in \\mathcal P_\\text{IV}$, then $\\TSLS$ is efficient in the class of $\\IV$ estimators calculated using instruments linear in $\\Z$. \n:::\n\n:::{.proof}\nSuppose $\\tilde{\\bet}$ is some arbitrary IV estimator which is linear in instruments $\\Z$. The instruments for this estimator can be written as $\\tilde{\\X} = \\Z\\F$ for some $L\\times K$ matrix $\\F$. We want to show that $\\avar{\\TSLS}$ is \"less than\" $\\avar{\\tilde{\\bet}}$. Both of these objects are matrices, so \"less\" than translates to the difference being PSD. This difference is \n\\begin{align*}\n\\avar{\\tilde{\\bet}} - \\avar{\\TSLS} & =\\frac{\\sigma^2}{n}\\E{\\tilde{\\X}'\\X}^{-1}\\E{\\tilde{\\X}'\\tilde{\\X}}\\E{\\X'\\tilde{\\X}}^{-1} -  \\frac{\\sigma^2}{n}\\E{\\hat{\\X}'\\hat{\\X}}^{-1}\\\\& = \\frac{\\sigma^2}{n}\\left[\\E{\\tilde{\\X}'\\X}^{-1}\\E{\\tilde{\\X}'\\tilde{\\X}}\\E{\\X'\\tilde{\\X}}^{-1} - \\E{\\hat{\\X}'\\hat{\\X}}^{-1}\\right]\\\\\n& = \\frac{\\sigma^2}{n}\\left[\\left[\\E{\\tilde{\\X}'\\X}\\E{\\tilde{\\X}'\\tilde{\\X}}^{-1}\\E{\\X'\\tilde{\\X}}\\right]^{-1} - \\E{\\hat{\\X}'\\hat{\\X}}^{-1}\\right] & (\\text{properties of inversion})\n\\end{align*}\nAccounting for the bracketed term being the difference of two inverted matrices, this matrix will be PSD if and only if the following is PSD: \n\\begin{equation}\n\\E{\\hat{\\X}'\\hat{\\X}} - \\E{\\tilde{\\X}'\\X}\\E{\\tilde{\\X}'\\tilde{\\X}}^{-1}\\E{\\X'\\tilde{\\X}}  (\\#eq:diff).\n\\end{equation}\n\nWe can show this by relying on a certain \"trick\". Define the difference between the regressors $\\X$ and 2SLS instruments $\\hat{\\X}$ as $\\mathbf r = \\hat{\\X} -  \\X$. This remainder term $\\mathbf r$ is uncorrelated with $\\Z$:\n\\begin{align*}\n\\E{\\Z'\\mathbf r} & = \\E{\\Z'\\hat{\\X}} - \\E{\\Z'\\X}\\\\\n& = \\E{\\Z'\\Z(\\Z'\\Z)^{-1}\\Z'\\X} - \\E{\\Z'\\X} & (\\hat{\\X} = \\Z(\\Z'\\Z)^{-1}\\Z'\\X)\\\\\n& = \\E{\\Z'\\X} - \\E{\\Z'\\X}\\\\\n& = \\zer\n\\end{align*}\nAs a result, $\\tilde{ \\X}$ and $\\mathbf r$ are uncorrelated. $$\\E{\\tilde{ \\X}'\\mathbf r} = \\E{(\\Z\\F')\\mathbf r}= \\mathbf F'\\underbrace{\\E{\\Z'\\mathbf r}}_\\zer = \\zer$$ Now we use these expectations and the definition of $\\mathbf r$ to arrive at our \"trick\".\n\\begin{align*}\n&\\E{\\tilde{ \\X}'\\mathbf r} = \\zer \\\\\n\\implies & \\E{\\tilde{ \\X}'(\\hat{\\X} -  \\X)} = \\zer & (\\mathbf r = \\hat{\\X} -  \\X)\\\\\n\\implies & \\E{\\tilde{ \\X}'\\hat{\\X}} - \\E{\\tilde{ \\X}'\\X} = \\zer\\\\\n\\implies & \\E{\\tilde{ \\X}'\\hat{\\X}} = \\E{\\tilde{ \\X}'\\X}\n\\end{align*}\nUsing this equality, we can rewrite the difference in Equation \\@ref(eq:diff) in terms of $\\tilde{\\X}$ and $\\hat{\\X}$ only.\n\\begin{equation}\n\\E{\\hat{\\X}'\\hat{\\X}} - \\E{\\hat{\\X}'\\tilde{\\X}}\\E{\\tilde{\\X}'\\tilde{\\X}}^{-1}\\E{\\tilde{\\X}'\\hat{\\X}}  (\\#eq:diff2).\n\\end{equation} This may seem like a random equation, but it's very special if you consider the linear projection of $\\hat{\\X}$ onto $\\tilde{\\X}$. This projection is given by the coefficient $\\boldsymbol\\gamma = \\E{\\tilde{\\X}'\\tilde{\\X}}^{-1}\\E{\\tilde{\\X}'\\hat{\\X}},$ which happens to show up in \\@ref(eq:diff2). The errors associated with this linear projection are given as $\\boldsymbol \\nu = \\hat{\\X} - \\tilde{\\X}\\boldsymbol\\gamma$, and have an expected value of $\\zer$ by the definition of $\\boldsymbol\\gamma$ and linear projection. But what is the expected value of these errors squared? \n\n\\begin{align*}\n \\boldsymbol \\nu' \\boldsymbol \\nu& = [\\hat{\\X} - \\tilde{\\X}\\boldsymbol\\gamma]'[\\hat{\\X} - \\tilde{\\X}\\boldsymbol\\gamma]\\\\\n& = \\hat{\\X}'\\hat{\\X} - 2\\boldsymbol\\gamma'\\tilde{\\X}'\\hat{\\X} + \\boldsymbol\\gamma'\\tilde{\\X}'\\tilde{\\X}\\boldsymbol\\gamma\\\\\n\\E{ \\boldsymbol \\nu' \\boldsymbol \\nu} & = \\E{\\hat{\\X}'\\hat{\\X}} - 2\\boldsymbol\\gamma'\\E{\\tilde{\\X}'\\hat{\\X}} + \\boldsymbol\\gamma'\\E{\\tilde{\\X}'\\tilde{\\X}}\\boldsymbol\\gamma & (\\boldsymbol\\gamma \\text{ is a constant})\\\\\n& = \\E{\\hat{\\X}'\\hat{\\X}} - 2\\left[\\E{\\tilde{\\X}'\\tilde{\\X}}^{-1}\\E{\\tilde{\\X}'\\hat{\\X}}\\right]'\\E{\\tilde{\\X}'\\hat{\\X}} + \\left[\\E{\\tilde{\\X}'\\tilde{\\X}}^{-1}\\E{\\tilde{\\X}'\\hat{\\X}}\\right]'\\E{\\tilde{\\X}'\\tilde{\\X}} \\left[\\E{\\tilde{\\X}'\\tilde{\\X}}^{-1}\\E{\\tilde{\\X}'\\hat{\\X}}\\right]\\\\\n& = \\E{\\hat{\\X}'\\hat{\\X}} - 2\\E{\\tilde{\\X}\\hat{\\X}'}\\E{\\tilde{\\X}'\\tilde{\\X}}^{-1}\\E{\\tilde{\\X}'\\hat{\\X}} + \\E{\\tilde{\\X}\\hat{\\X}'}\\underbrace{\\E{\\tilde{\\X}'\\tilde{\\X}}^{-1}\\E{\\tilde{\\X}'\\tilde{\\X}}}_{\\mathbf I} \\E{\\tilde{\\X}'\\tilde{\\X}}^{-1}\\E{\\tilde{\\X}'\\hat{\\X}}\\\\\n& = \\E{\\hat{\\X}'\\hat{\\X}} - (2-1)\\E{\\tilde{\\X}\\hat{\\X}'}\\E{\\tilde{\\X}'\\tilde{\\X}}^{-1}\\E{\\tilde{\\X}'\\hat{\\X}} \\\\\n& = \\E{\\hat{\\X}'\\hat{\\X}} - \\E{\\hat{\\X}'\\tilde{\\X}}\\E{\\tilde{\\X}'\\tilde{\\X}}^{-1}\\E{\\tilde{\\X}'\\hat{\\X}}\n\\end{align*}\nEquations \\@ref(eq:diff) and \\@ref(eq:diff2) are the expectation of the sum of squared errors associated with the linear projection of $\\hat{\\X}$ onto $\\tilde{\\X}$, meaning the matrix in question must be PSD!^[Intuitively, this matrix must be PSD in the same way the sum of squared numbers cannot be negative.] This gives the desired result.\n:::\n\nIn Section \\@ref(generalized-method-of-moments) we'll see another way to show this result that is a bit more intuitive. \n\n\n:::{#exm-se}\n\n## What's in A Name?\n\nLet's estimate the model from \\@ref(exm:ex4) via 2SLS. We already have defined a function ```IV()``` to calculate $\\IV$, so we can just use pass the instruments $\\hat {\\X}$ to this function to perform 2SLS.\n\n```{r}\nTSLS <- function(y,X,Z){\n  X_hat <- Z %*% solve(t(Z) %*% Z) %*% t(Z) %*% X\n  output <- IV(y, X, X_hat)\n  return(output)\n}\n```\n\nFor a simulated sample of size $n=50$ let's estimate the model using ```TSLS()```.  \n\n```{r}\nmodel <- sim_endog_linear_model(beta = c(1,2),\n  n = 50,\n  dist_vec = c(rmvnorm),\n  dist_params_list = list(\n    list(\n      c(1, 10, 10, 0),\n      matrix(c(20,5,10,1,5,30,7,0,10,7,50,0,1,0,0,1), nrow = 4)\n    )\n  )\n)\n\nTSLS(model$y, model$X, model$Z) %>% \n  knitr::kable()\n```\n\nThis is not the only way we could calculate $\\TSLS$. Note that $\\Zm(\\Zm'\\Zm)^{-1}\\Zm'$ is symmetric and idempotent, so \n\\begin{align*}\n\\TSLS & = \\IV(\\Xm, \\hat{\\Xm}, \\Y)\\\\\n& = [\\hat{\\Xm}'{\\Xm}]^{-1}\\hat{\\Xm}'\\Y\\\\\n& = [\\Xm'\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm]^{-1}\\Xm'\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Y\\\\\n& = [\\Xm'[\\Zm(\\Zm'\\Zm)^{-1}\\Zm']\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm]^{-1}\\Xm'\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Y\\\\\n& = [[\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm]'[\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Xm]]^{-1}\\Xm'\\Zm(\\Zm'\\Zm)^{-1}\\Zm'\\Y\\\\\n& = [\\hat{\\Xm}'\\hat{\\Xm}]^{-1}\\hat{\\Xm}'\\Y\\\\\n& = \\OLS(\\hat{\\Xm}, \\Y).\n\\end{align*}\nSo we can interpret $\\TSLS$ in one of two ways:\n\n1. Use $\\OLS(\\Zm, \\Xm)$ to calculate $\\hat{\\Xm} = \\Zm\\OLS(\\Zm, \\Xm)$ (stage 1), followed by $\\IV(\\Xm, \\hat{\\Xm}, \\Y)$ (stage 2). This is how our ```TSLS()``` function works.\n2. Use $\\OLS(\\Zm, \\Xm)$ to calculate $\\hat{\\Xm} = \\Zm\\OLS(\\Zm, \\Xm)$ (stage 1), followed by $\\OLS(\\hat{\\Xm}, \\Y)$ (stage 2).\n\nThe second interpretation is where 2SLS gets its name -- we run OLS twice. But what happens when we implement $\\TSLS$ this way?\n \n```{r}\nstage1 <- lm(x2 ~ z2 + z3, data = model$observed_data)\nX_hat <- stage1$fitted.values\nstage2 <- lm(model$y ~ X_hat) \n\nstage2 %>% \n  tidy() %>% \n  knitr::kable()\n```\n\nWe get the same exact estimates (which we already showed would be the case), but our standard errors don't coincide with those given by ```TSLS()```. What is happening here? \n\nWhen we run ```lm(y ~ X_hat)```, we are estimating the model associated with linear projection model $Y = \\hat{\\X}\\boldsymbol \\delta + \\nu$. The function ```lm()``` has no way of knowing that this is the second step in an estimation process aimed at estimating the structural linear model $Y = \\X\\bet + \\varepsilon$. It just happens that $\\hat{\\X}$ is defined such that the population parameters satisfy $\\boldsymbol \\delta = \\bet$. When ```lm()``` goes to calculate the standard errors, it calculates the residuals associated with the model $Y = \\hat{\\X}\\boldsymbol \\delta + \\nu$. These errors have no structural/economic meaning, and we don't care about them at all (for this purpose). We really want the residuals associated with the error $\\varepsilon$ in the actual IV model $Y = \\X\\bet + \\varepsilon$, and these residuals are not the same!\n$$ \\hat{\\mathbf u} = \\Y - \\hat{\\Xm}\\OLS(\\hat{\\Xm}, \\Y) \\neq \\Y - \\Xm\\OLS(\\hat{\\Xm}, \\Y) = \\Y- \\Xm\\IV(\\Xm, \\hat{\\Xm}, \\Y) = \\hat{\\e}$$\nThe moral of the story is that when we are calculating the residuals we need to be very deliberate and remember the actual model we are estimating. Fortunately, any statistical software with an implementation for $\\TSLS$ will calculate the correct standard errors, which is why it's best to not do each step \"by hand\" if you favor the interpretation of $\\TSLS$ as two OLS regressions.\n\n```{r}\nivreg(y ~ x2 | z2 + z3, data = model$observed_data) %>% \n  tidy() %>% \n  knitr::kable()\n```\n\n:::\n\nThe example emphasizes something that has been mentioned in passing before. The models estimated in the first and second stage, $\\X = \\Z\\boldsymbol + \\gamma$ and  $Y = \\hat{\\X}\\boldsymbol \\delta + \\nu$, are entirely void of structural meaning. Nevertheless it is useful to us because it expresses the outcome of interest in terms of exogenous variables $\\hat{\\X}$ and $\\Z$. We refer to such an equation as the **_reduced form_** of the structural model $Y = \\X\\bet + \\ep$. We'll talk about this term much more in Section \\@ref(endogeniety-ii-simultaneous-equation-models).\n\n## Testing Hypotheses\n\nAt this point, we have just assumed we know how to select between the classical linear model $\\mathcal P_\\text{LM}$ and the linear IV model $\\mathcal P_\\text{IV}$, but in practice we want to be able to form hypothesis tests that inform our selection between the two models. In particular we want to be able to test: \n\n1. Are our regressors exogenous, i.e $H_0: \\E{\\X'\\ep} = \\zer$?\n2. Are our instruments valid, i.e...\n\n### Durbin–Wu–Hausman Test\n\nWe'll start with considering tests for exogenous/endogenous regressors. One sign that our model contains endogenous regressors is if there is a significant difference between $\\OLS$ and $\\IV$. This is why it's always a good idea to estimate a model with $\\OLS$ even if you think regressors are endogenous. It provides a good reference to compare IV estimates with. In fact, comparing $\\OLS$ and $\\IV$ serve as the basis for one of the most common tests for endogeneity as formalized by @hausman1978specification.^[This happens to be one of the most cited papers in all of economics.] \n\nIn the face of endogeneity, $\\OLS$ is an abject failure in light of its inconsistency. Fortunately, $\\IV$ is consistent when $\\X$ is endogenous. Furthermore, $\\IV$ is also consistent when $\\X$ is exogenous, as the instruments $\\Z$ are still valid and relevant. In other words, if $\\X$ is exogenous, then $\\OLS\\pto \\bet$ *and* $\\IV\\pto\\bet$, so \n$$ \\OLS - \\IV \\pto \\zer.$$ This suggests the following: \n$$ H_0: \\X \\text{ exogenous} \\iff H_0:\\plim\\left(\\OLS - \\IV\\right) = \\zer.$$ We can construct a Wald test statistic\n$$ W = (\\OLS - \\IV)' \\left[\\widehat{\\text{Avar}}(\\OLS - \\IV) \\right]^{-1}(\\OLS - \\IV),$$ but we will run into a roadblock in the form of $\\avar{\\OLS - \\IV}$. If we expand this, we have \n\n$$ \\avar{\\OLS - \\IV} = \\avar{\\IV} + \\avar{\\OLS} - 2\\text{Acov}\\left(\\IV,\\OLS\\right),$$ as $\\IV$ and $\\OLS$ are presumably correlated. We don't have a formula for the covariance of these estimators handy, and deriving one would be a pain. Fortunately, we don't have to, because Lemma 2.1 of @hausman1978specification asserts that the covariance term is such that \n$$  \\avar{\\OLS - \\IV} =  \\avar{\\IV} - \\avar{\\OLS}$$\ndue to $\\OLS$ being efficient relative to $\\IV$.^[In Example \\@ref(exm:ref3) we saw that $\\OLS$ is more efficient than $\\IV$ in the event that our regressors are exogenous. This was formalized in Theorem \\@ref(thm:eff2), because in the event that all regressors $\\X$ are exogenous and we have non-trivial instruments $\\Z$, then $\\TSLS$ \"picks\" the optimal trivial instruments $\\X$ and our estimator reduces to $\\OLS$.] This is a particular useful equality, and interesting result in it's own right. @hansen2022econometrics refers to it as the \"Hausman equality\", and gives details about it in Section 8.11. This gives the test statistic\n\\begin{align*}\nW &= (\\OLS - \\IV)'\\left[\\widehat{\\text{Avar}}(\\IV) - \\widehat{\\text{Avar}}(\\OLS)\\right]^{-1} (\\OLS - \\IV).\n\\end{align*}\n\nUnfortunately, the term corresponding to the asymptotic variance will likely fail to be invertible. Unless $\\X$ and $\\Z$ contain no common variables, some column of  $(\\hat{\\Xm}'\\hat{\\Xm})^{-1} - (\\Xm'\\Xm)^{-1}$ will be a linear combination of other columns. For example, if our model contains an intercept, than we cannot use this statistic, as $\\X$ and $\\Z$ will both contain a column of 1's. This rules out just about every single situation we would ever want to consider. To address this shortcoming, we can take the [pseudo-inverse](https://mathworld.wolfram.com/Moore-PenroseMatrixInverse.html) of this matrix.\n\n$$W = (\\OLS - \\IV)'\\left[\\widehat{\\text{Avar}}(\\IV) - \\widehat{\\text{Avar}}(\\OLS)\\right]^+ (\\OLS - \\IV)$$\nThe hypothesis $\\OLS - \\IV\\pto \\zer$ is comprised of $K$ separate hypotheses, so it's tempting to conclude  $W\\sim \\chi_K^2$. Unfortunately, this will only be the case when $\\avar{\\IV} - \\avar{\\OLS}$ is invertible, otherwise we will have $W\\sim \\chi_q^2$ where $q = \\text{rank} \\left[ \\avar{\\IV} - \\avar{\\OLS} \\right]$.\n\n:::{#thm-}\n\n## Hausman Specification Test\n\nGiven the hypothesis $H_0:\\hat{\\thet}_e\\pto\\thet, \\hat{\\thet}\\pto\\thet$ for some asymptotically efficient estimator $\\hat{\\thet}_e$, the <span style=\"color:red\">**_Hausman statistic_**</span> is defined as \n$$H = (\\hat{\\thet} - \\hat{\\thet}_e)'\\left[\\widehat{\\text{Avar}}(\\hat{\\thet}) - \\widehat{\\text{Avar}}(\\hat{\\thet}_e)\\right]^+ (\\hat{\\thet} - \\hat{\\thet}_e).$$ Under $H_0$,\n$$ H\\sim \\chi_q^2$$\nwhere $q = \\text{rank}\\left[\\avar{ \\hat{\\thet}} - \\avar{ \\hat{\\thet}_e}\\right]$. The test associated with this statistic is known as the <span style=\"color:red\">**_Hausman specification test_**</span>. \n:::\n \nThe Hausman test is far more general that testing for endogeneity, it just happens that testing for endogeneity is a great application of it. That being said, actually calculating $H$ in the context of $\\OLS$ and $\\IV$ isn't cut and dried. There are a handful of approaches to this, many of which predate @hausman1978specification in fact. @durbin54 and @wu1973alternative independently proposed methods of testing $H_0: \\X \\text{ exogenous}$ based on the idea of contrasting $\\OLS$ with $\\IV$. The different flavors in test arise from choices about the estimate of $S^2$ used to calculate $\\widehat{\\text{Avar}}(\\IV)$ and $\\widehat{\\text{Avar}}(\\OLS)$, along with whether the intercept term is included in $\\X$ and $\\Z$.   \n\n\n:::{#exm-}\n\ntest \n\n```{r}\ncompare_s2 <- function(beta, n, dist_vec, dist_params_list, t){\n  model <- sim_endog_linear_model(beta, n, dist_vec, dist_params_list)\n  \n  K <- ncol(model$X)\n  OLS <- lm(model$y ~ model$X - 1)\n  IV <- ivreg(model$y ~ model$X - 1 | model$Z - 1)\n  \n  output <- tibble(\n    S2_IV = sum(residuals(IV)^2) / (n - K),\n    S2_OLS = sum(residuals(OLS)^2) / (n - K),\n    S2_MLE = sum(residuals(OLS)^2) / n,\n    iter_num = t\n  )\n  \n  return(output)\n}\n\ncompare_s2_N_times <- function(N, beta, n, dist_vec, dist_params_list){\n  output <- 1:N %>% \n    map(compare_s2, beta = beta, n = n, dist_vec = dist_vec, dist_params_list = dist_params_list) %>% \n    bind_rows()\n  return(output)\n}\n\n\n# xz_1 <- 0.5\n# xz_2 <- 0.5\n# zz <- 0\n# xe <- 0\n# \n# \n# matrix(c(1, xz_1, xz_2, xe, \n#          xz_1, 1, zz, 0,\n#          xz_2, zz, 1, 0,\n#          xe, 0, 0, 1), nrow = 4)\n```\n\n\n```{r}\n# results %>%\n#   pivot_longer(!iter_num) %>%\n#   group_by(name) %>%\n#   summarize(\n#     variance = sd(value)\n#   ) %>% \n#   knitr::kable()\n```\n\n\n:::\n\n:::{#cor-hausend}\n\n## Hausman Test for Endogeneity\n\nGiven the hypothesis $H_0:\\E{\\X'\\ep} = \\zer$ where regressors are partitioned as $\\X = [\\X_\\text{exo},\\X_\\text{end}]$, the <span style=\"color:red\">**_Hausman statistic_**</span> simplifies to\n$$H = (\\hat{\\boldsymbol\\beta}_\\text{OLS,end} - \\hat{\\boldsymbol\\beta}_\\text{IV,end})'\\left[\\widehat{\\text{Avar}}(\\hat{\\boldsymbol\\beta}_\\text{IV,end}) - \\widehat{\\text{Avar}}(\\hat{\\boldsymbol\\beta}_\\text{OLS,end})\\right]^{-1} (\\hat{\\boldsymbol\\beta}_\\text{OLS,end} - \\hat{\\boldsymbol\\beta}_\\text{IV,end}).$$ Under $H_0$,\n$$ H\\sim \\chi_q^2$$\nwhere $q = \\dim(\\X_\\text{end})$. I will call the test associated with this statistic is known as the <span style=\"color:red\">**_Hausman test for endogeneity_**</span>. \n:::\n\n:::{#exm-}\n\nSuppose $(X, Z, \\varepsilon) \\sim N(\\boldsymbol \\mu,\\Sig)$ where\n\\begin{align*}\n\\boldsymbol \\mu & = [10,10,0]',\\\\\n\\Sig & = \\begin{bmatrix}20 & 5 & 0\\\\5&20&0\\\\0&0&1 \\end{bmatrix},\n\\end{align*}\nand $Y = 1 + 3X + \\varepsilon$. We have $\\cov{X,\\varepsilon} = 0$, so $\\E{X\\varepsilon} = 0$ and our model meets the assumptions of the classical linear model ($P_{\\bet,\\sigma^2} \\in \\mathcal P_\\text{LM}\\subset\\mathcal P_\\text{IV}$). If we draw a sample of size $n = 1,00$, we can test $H_0:\\E{X\\varepsilon} = 0$ using the Hausman statistic calculated using only $\\beta_2$ (the slope coefficient). If we repeat this simulation many times, then the distribution of our test statistic should approach $\\chi_1^2$, as $H_0$ is true for our model. \n\n```{r}\nDWH_test <- function(y, X, Z, end_col){\n  P <- Z %*% solve(t(Z) %*% Z) %*% t(Z)\n  X_hat <- P %*% X\n  OLS <- solve(t(X) %*% X) %*% t(X) %*% y\n  IV <- solve(t(X_hat) %*% X) %*% t(X_hat) %*% y\n  \n  S2_OLS <- sum((y - X %*% OLS)^2) / (nrow(X) - ncol(X))\n  S2_IV <- sum((y - X %*% IV)^2) / (nrow(X) - ncol(X))\n  S2_eff <- sum((y - X %*% OLS)^2) / nrow(X)\n  \n  V_OLS <- S2_OLS*solve(t(X) %*% X)\n  V_IV <- S2_IV*solve(t(X_hat) %*% X_hat)\n  \n\n  H1 <- t(IV[-1] - OLS[-1]) %*% pinv(as.matrix(V_IV[-1,-1] - V_OLS[-1,-1])) %*% (IV[-1] - OLS[-1])\n  H2 <- t(IV - OLS) %*% pinv(V_IV - V_OLS) %*% (IV - OLS)\n  H3 <- (t(IV - OLS) %*% pinv(solve(t(X_hat) %*% X_hat) - solve(t(X) %*% X)) %*% (IV - OLS))/S2_OLS\n  H4 <- (t(IV - OLS) %*% pinv(solve(t(X_hat) %*% X_hat) - solve(t(X) %*% X)) %*% (IV - OLS))/S2_IV\n  H5 <- (t(IV - OLS) %*% pinv(solve(t(X_hat) %*% X_hat) - solve(t(X) %*% X)) %*% (IV - OLS))/S2_eff\n  H6 <- lm(y ~ X + P %*% X[,end_col] - 1) %>%\n    tidy() %>% \n    slice(ncol(X) - 1 + end_col) %>% \n    mutate(statistic = statistic^2) %>%\n    select(statistic) %>% \n    as.numeric()\n  \n  output <- tibble(\n    stat = c(H1, H2, H3, H4, H5, H6),\n    include_constant = c(F, T, T, T, T, NA),\n    common_S2_value = c(NA, NA, \"OLS\", \"IV\", \"MVE\", NA),\n    version = 1:6\n  )\n  \n  return(output)\n}\n\ndraw_DWH_test <- function(end_col, beta, n, dist_vec, dist_params_list, t){\n  model <- sim_endog_linear_model(beta, n, dist_vec, dist_params_list)\n  output <- DWH_test(model$y, model$X, model$Z, end_col) %>% \n    mutate(iter_num = t)\n  return(output)\n}\n\ndraw_N_DWH_test <- function(N, end_col, beta, n, dist_vec, dist_params_list){\n  output <- 1:N %>% \n    map(draw_DWH_test, end_col = end_col, beta = beta, n = n, dist_vec = dist_vec, dist_params_list = dist_params_list) %>% \n    bind_rows()\n  return(output)\n}\n\n# results <- draw_N_DWH_test(\n#   N = 1e3,\n#   end_col = 2,\n#   beta = c(0,3),\n#   n = 1e3,\n#   dist_vec = c(rmvnorm),\n#   dist_params_list = list(\n#     list(\n#       mean = c(10, 10, 0),\n#       sigma = matrix(c(20,5,0, 5,20,0,0,0,3), nrow = 3)\n#     )\n#   )\n# )\n\n\nk <- 3\nS <- diag(2*k+1)\nfor (i in 1:k) {\n  S[i, 2*k+1] <- S[2*k+1, i] <- 0.5\n  S[i+k,i] <- S[i,i+k] <- 0.5\n}\n\n\nmodel <- sim_endog_linear_model(\n  beta = c(1, 1, 1, 1),\n  n = 1e3,\n  dist_vec = c(rmvnorm),\n  dist_params_list = list(\n    list(\n      mean = c(0, 0, 0, 0, 0, 0, 0),\n      sigma = S\n    )\n  )\n)\n\ny <- model$y\nX <- model$X\nZ <- model$Z\nP <- Z %*% solve(t(Z) %*% Z) %*% t(Z)\nh <- rbind(c(0,0,0,1,0,0), c(0,0,0,0,1,0), c(0,0,0,0,0,1))\n\nlm(y ~ X + P %*% X[, c(2, 3, 4)] - 1)\nP %*% X[, c(2, 3, 4)]\n\nols <- coef(lm(y ~ X + P %*% X[, c(2, 3, 4)] - 1))\n# var <- vcov(lm(y ~ X + P %*% X[, c(2, 3, 4)] - 1))\n\n# lm(y ~ X + P %*% X[, c(2, 3)] - 1)\n# t(h %*% ols) %*% solve(h %*% var %*% t(h)) %*% (h %*% ols) / 2\n# summary(ivreg(y ~ x2 + x3 + x4 | z2 + z3 + z4 , data = model$observed_data), diagnostics = T)$diagnostics[3,3]\n```\n\nNow let's plot the simulated test statistics.\n\n```{r}\n# results %>% \n#   ggplot(aes(stat, fill = as.factor(version))) +\n#   geom_histogram(alpha = 0.4, position = \"identity\")\n```\n\nWe'll replicate section 1.5 from @chmelarova2007hausman which uses data from @mroz and is inspired by Example 9.5 from @wooldridge2010econometric. \n\n```{r}\n# data(\"mroz\")\n# mroz <- mroz %>%\n#   as_tibble() %>%\n#   filter(hours > 0)\n# \n# \n# y <- mroz$hours\n# X <- mroz %>%\n#   select(int = 1, lwage, educ, age, kidslt6, kidsge6, nwifeinc) %>%\n#   as.matrix()\n# Z <- mroz %>%\n#   select(int = 1, exper, educ, age, kidslt6, kidsge6, nwifeinc) %>%\n#   as.matrix()\n# \n# \n# rho1 \n# rho2 \n# rho3 \n# rho4 \n# \n# sim_endog_linear_model(\n#   beta = c(0,1),\n#   n = 1e2,\n#   dist_vec = c(rmvnorm),\n#   dist_params_list = list(\n#     list(\n#       mean = c(0, 0, 0, 0),\n#       sigma = matrix(\n#         c(1, 5, 0, 5,\n#           20, 0, 0, 0,\n#           3, 0, 1, 0,\n#           0, 0, 0, 1\n#           ), nrow = 3)\n#     )\n#   )\n# )\n```\n\n:::\n\nAnother means of testing for exogeneity is due to  @wu1973alternative and @durbin1954errors. Begin by performing the first step of 2SLS on the possible endogenous regressors.\n$$ \\Xm_\\text{end} =  \\Zm \\boldsymbol \\delta + \\mathbb V$$ The residuals now form a matrix, because we have multiple dependent variables $\\X_\\text{end}$.\nUsing the estimated projection coefficient $\\hat{\\boldsymbol \\delta}$, we calculated the residual values $\\hat{\\mathbb V}$. Finally we augment the original linear model by including $\\hat{\\mathbb V}$.\n\n$$\\y = \\Xm\\bet + \\hat{\\mathbb V}\\boldsymbol\\gamma + \\ep^* = \\begin{bmatrix} \\Xm_\\text{exo} & \\Xm_\\text{end}\\end{bmatrix}\\begin{bmatrix} \\bet_\\text{exo} \\\\ \\bet_\\text{end}\\end{bmatrix} + \\underbrace{\\hat{\\mathbb V}\\gamma + \\boldsymbol {\\ep}^*}_{\\ep}$$ Consider the hypothesis $H_0:\\boldsymbol\\gamma = \\zer$, and how that may related to whether $\\Xm_\\text{end}$ is endogenous or exogenous. When we perform the first step of this process (regressing $\\Xm_\\text{end}$ on $\\Zm$) we break variation in $\\Xm_\\text{end}$ into two parts: the exogenous portion explained through $\\Zm$,^[We know it's exogenous because $\\Zm$ is a valid instrument and is exogenous], and unexplained part $\\boldsymbol \\nu$ which we capture through $\\hat{\\mathbb V}$. If $\\boldsymbol \\gamma \\neq \\zer$, then the structural error $\\ep$ includes the unexplained part of the variation in $\\X_\\text{end}$, which is another way of saying $\\cov{\\X_\\text{end}, \\varepsilon}\\neq 0$. \n\nSo do we use the Hausman test, or this new test which uses artificial regressions? Well it turns out, we don't need to make a choice because they're equivalent if we are attentive about which residuals we use to calculate asymptotic variance! It also turns out that we could perform the artificial regression test using the fitted values $\\hat{\\Xm}_\\text{end}$ instead of $\\hat{\\mathbb V}$. \n\n\n\n\n\n### Sargan–Hansen Test\n\n\n## Example/Replication\n\nLet's replicate @card1995using, a *classic* paper which has provided a textbook example of instrumental variables. To make sure our results are correct, we can compare them to the tables in the original paper which is found [here](https://www.nber.org/system/files/working_papers/w4483/w4483.pdf). The data is available on David Card's [website](https://davidcard.berkeley.edu/data_sets.html).\n\n@card1995using is concerned with estimating the returns to schooling with respect to wages. We tend to think that better educated workers earn higher wages, but to what extent does this relationship hold? Denote years of schooling as $S_i$, log wages as $Y_i$, and $\\X_i$ as a collection of attributes associated with a worker. The linear model of interest is \n$$ Y_i = \\X_i\\boldsymbol\\alpha + S_i\\beta + u_i,$$ where $u_i$ are unobserved components which affect earnings. We're assuming that $\\E{\\X_iu_i} = 0$ for all $i$ ($\\X_i$ is exogenous), but we suspect that $\\E{S_iu_i} = 0$ (see Example \\@ref(exm:ex1)). The parameter $\\beta$ is the returns of education on earnings, and is what we're primarly interested in. Let's just ignore this endogeneity for now and attempt to estimate $\\beta$ with OLS. We can do this with data from the National Longitudinal Survey of Young Men (NLSYM) conducted in 1976. This survey contains information about agents' wages in 1976, along with demographic information about family background, residence in 1976, and past residence (in 1966). The details of this survey, in particular how respondents were sampled, can be found in @card1995using.\n\n```{r, message=FALSE}\ncard_95 <- read.table(\"data/nls.dat\")\n```\n\nThe ```.zip``` file containing the data also contains a ```.sas``` file which processes and cleans the raw data. Each step is readily executed in R:^[I did this to the best of my ability, as I have no experience with ```.sas```, and I could have misinterpreted the accompanying documentation and commentary in the code.]\n\n```{r, message=FALSE}\ncard_95 <- card_95 %>%\n  #assign the appropriate names to each variable\n  rename(\n    id = V1,\n    nearc2 = V2,\n    nearc4 = V3,\n    nearc4a = V4,\n    nearc4b = V5,\n    ed76 = V6,\n    ed66 = V7,\n    age76 = V8,\n    daded = V9,\n    nodaded = V10,\n    momed = V11,\n    nomomed = V12,\n    weight = V13,\n    momdad14  = V14,\n    sinmom14  = V15,\n    step14 = V16,\n    reg661 = V17,\n    reg662 = V18,\n    reg663 = V19,\n    reg664 = V20,\n    reg665 = V21,\n    reg666 = V22,\n    reg667 = V23,\n    reg668 = V24,\n    reg669 = V25,\n    south66 = V26,\n    work76 = V27,\n    work78 = V28,\n    lwage76 = V29,\n    lwage78 = V30,\n    famed = V31,\n    black = V32,\n    smsa76r = V33,\n    smsa78r = V34,\n    south76 = V35,\n    reg78r = V36,\n    reg80r = V37,\n    smsa66r = V38,\n    wage76 = V39,\n    wage78 = V40,\n    wage80 = V41,\n    noint78 = V42,\n    noint80 = V43,\n    enroll76 = V44,\n    enroll78 = V45,\n    enroll80 = V46,\n    kww = V47,\n    iq = V48,\n    marsta76 = V49,\n    marsta78 = V50,\n    marsta80 = V51,\n    libcrd1 = V52\n  ) %>% \n  mutate(\n    # missing values in SAS are \".\", replace those with NAs\n    across(everything(), ~replace(., . ==  \".\" , NA)),\n    # any column that had a \".\" was loaded as a string, convert them\n    across(where(is.character), as.numeric),\n    #create variables corresponding to work experience\n    exp76 = age76 - ed76 - 6,\n    exp76_sq = exp76*exp76,\n    exp76_sq_100 = (exp76*exp76)/100,\n    #create a series of indicators for parents' level of education\n    f1 = (momed > 12 & daded > 12),\n    f2 = (momed >= 12 & daded >= 12 & (momed != 12 | daded != 12)),\n    f3 = (momed == 12 & daded == 12),\n    f4 = (momed >= 12 & nodaded == 1),\n    f5 = (daded >= 12 & momed < 12),\n    f6 = (momed >= 12 & nodaded == 0),\n    f7 = (momed >= 9 & daded >= 9),\n    f8 = (nomomed == 0 & nodaded == 0)\n  )\n\n#Gather mutually exclusive region66 indicators into categorical \ncard_95 <- card_95 %>% \n  select(id, contains(\"reg66\")) %>% \n  gather(region66, count, -id) %>% \n  filter(count == 1) %>% \n  mutate(\n    region66 = str_remove(region66,\"reg66\"),\n    region66 = as.factor(region66)\n  ) %>% \n  right_join(card_95)\n```\n\nThe dependent variable of interest if $\\log wage_i$ (```lwage76```). Our baseline linear model is\n$$ \\log( wage_i) = \\alpha_0 + \\beta\\cdot educ_i + \\alpha_1\\cdot exper_i + \\frac{\\alpha_2}{100}\\cdot exper_i^2 + \\alpha_3 \\cdot black_i + \\alpha_4\\cdot south_i + \\alpha_5\\cdot SMSA_i + \\varepsilon_i,$$ where $educ_i$ (```ed76```) is level of education, $exper_i$ (```exp76```) is amount of work experiance, $black_i$ (```black```) indicated if respondent $i$ is Black, $south_i$ (```south76```) indicated whether the respondent lives in the South (in 1976), and $SMSA_i$ (```smsa76r```) indicates whether a respondent lives in the South and in a metropolitan area.^[The abbreviation \"MSA\" comes up a lot when dealing with surbey data. It stands for \"metropolitan statistical area\", and are used by the Census Bureau to designate areas with a high population density.] Along with estimating this model, we will estimate similar models which include various controls for family education, family structure, and where respondents lived in 1966. \n\n```{r}\nlinear_model1 <- lm(lwage76 ~ ed76 + exp76 + exp76_sq_100 + black + south76 + smsa76r, data = card_95)\nlinear_model2 <- lm(lwage76 ~ ed76 + exp76 + exp76_sq_100 + black + south76 + smsa76r + smsa66r + region66, data = card_95)\nlinear_model3 <- lm(lwage76 ~ ed76 + exp76 + exp76_sq_100 + black + south76 + smsa76r + smsa66r + region66 +\n                      daded + momed + nodaded + nomomed, data = card_95)\nlinear_model4 <- lm(lwage76 ~ ed76 + exp76 + exp76_sq_100 + black + south76 + smsa76r + smsa66r +\n                      region66 + daded + momed + nodaded + nomomed + f1 + f2 + f3 + f4 + \n                      f5 + f6 + f7 + f8, data = card_95)\nlinear_model5 <- lm(lwage76 ~ ed76 + exp76 + exp76_sq_100 + black + south76 + smsa76r + smsa66r +\n                     region66+ daded + momed + nodaded + nomomed + f1 + f2 + f3 + f4 + \n                      f5 + f6 + f7 + f8 + momdad14 + sinmom14, data = card_95)\n```\n\nOur results should match Table 2 of @card1995using. The ```stargazer``` package gives us a flexible means of tabulating regression results.^[Right now, the table is formatted in html and automatically included when this Rmarkdown file is knit, but you ```stargazer``` is also capable of outputting very nice tables in $\\LaTeX$.]\n\n```{r, results='asis', echo=FALSE}\n# stargazer(linear_model1,\n#           linear_model2, \n#           linear_model3, \n#           linear_model4, \n#           linear_model5, \n#           header=FALSE, \n#           type = 'html',\n#           omit = c(\"f\", \"reg\", \"momed\", \"nodaded\", \"daded\", \"momdad14\", \"sinmom14\", \"Constant\", \"nomomed\", \"smsa66\"),\n#           no.space = TRUE,\n#           add.lines=list(c('Region in 1966', 'No','Yes', \"Yes\", \"Yes\", \"Yes\"),\n#                          c('SMSA 1966', 'No','Yes', \"Yes\", \"Yes\", \"Yes\"),\n#                          c('Parental Education', 'No','No', \"Yes\", \"Yes\", \"Yes\"),\n#                          c('Interacted Parental Education Classes', 'No','No', \"No\", \"Yes\", \"Yes\"),\n#                          c('Family Structure', 'No','No', \"No\", \"No\", \"Yes\")),\n#           omit.stat =c(\"f\", \"adj.rsq\", \"ser\"),\n#           notes = NULL,\n#           covariate.labels =c(\"Education\", \"Experiance\", \"Experiance-Squared/100\", \"Black indicator\", \"Live in South\", \"Live in SMSA\"),\n#           dep.var.labels = c(\"Log Hourly Earnings\")\n#           )\n```\n\nFor each model $\\hat\\beta_\\text{OLS}\\in[0.073,0.075]$, meaning that an additional year of education corresponds to roughly a 7.4% increase in earnings. We should be suspicious of these results though, as it's likely the case that $educ_i$ is endogenous, so we need some instrument(s) for $educ_i$.  @card1995using makes the case for using a variable which indicates whether a respondent grew up in a labor market with an accredited 4-year college, $near_\\ college_i$ (```nearc4```). In other words, the respondent lived near a college in the year 1966. This proximity to a college has no baring on earnings (in theory), but it is likely correlated with $educ_i$, as the cost of higher education is lower for those who have the option to live at home while attending college. Let's use $near_\\ college_i$ to calculate $\\hat\\beta_\\text{IV}$. We can do this \"by hand\" by estimating the following reduced form equations via OLS:^[While we're prone to make mistakes involving standard errors here, it's sort of the equivelent of \"showing your work\" on a math test.]\n\n\\begin{align*}\neduc_i &= \\gamma_0 + \\gamma_1 \\cdot near_\\ college_i + \\gamma_2\\cdot exper_i + \\frac{\\gamma_3}{100}\\cdot exper_i^2 + \\gamma_4 \\cdot black_i + \\gamma_5\\cdot region_i + \\gamma_6\\cdot SMSA_i + \\cdots + u_i\\\\\n\\log( wage_i) &= \\delta_0 + \\delta_1 \\cdot near_\\ college_i + \\delta_2\\cdot exper_i + \\frac{\\delta_3}{100}\\cdot exper_i^2 + \\delta_4 \\cdot black_i + \\delta_5\\cdot region_i + \\delta_6\\cdot SMSA_i + \\cdots + \\nu_i\\\\\n\\end{align*}\n\nWe could also directly estimate the structural model via $\\IV$ and not worry about messing up the standard errors. If we have done everything correctly we should see:\n$$ \\frac{\\hat \\delta_{\\text{OLS},1}}{\\hat \\gamma_{\\text{OLS},1}} = \\hat\\beta_\\text{IV}.$$\n```{r, echo=FALSE, fig.align='center', fig.asp = 0.5, fig.width = 1, fig.cap =\"test\", out.width = \"500px\"}\nknitr::include_graphics(\"figures/card_dag.png\")\n```\n\nWe will estimate the models with and without family controls, and restrict our attention to respondents where ```lwage76``` is not missing.\n\n```{r}\ncard_95 <- card_95 %>% \n  filter(!is.na(lwage76))\n\n#Without family controls \nreduced_form1_stage1 <- lm(ed76 ~ nearc4 + exp76 + exp76_sq_100 + black + south76 + smsa76r + smsa66r + region66, data = card_95)\nreduced_form1_stage2 <- lm(lwage76 ~ nearc4 + exp76 + exp76_sq_100 + black + south76 + smsa76r + smsa66r + region66, data = card_95)\nIV_model1 <- ivreg(lwage76 ~ ed76 + exp76 + exp76_sq_100 + black + south76 + smsa76r + smsa66r + region66 |\n                     nearc4 + exp76 + exp76_sq_100 + black + south76 + smsa76r + smsa66r + region66, data = card_95)\n\n#With family controls\nreduced_form2_stage1 <- lm(ed76 ~ nearc4 + exp76 + exp76_sq_100 + black + south76 + smsa76r + smsa66r + \n                             region66 + daded + momed + nodaded + nomomed + f1 + f2 + f3 + f4 + \n                             f5 + f6 + f7 + f8 + momdad14 + sinmom14, data = card_95)\nreduced_form2_stage2 <- lm(lwage76 ~ nearc4 + exp76 + exp76_sq_100 + black + south76 + smsa76r + smsa66r + region66 + \n                             daded + momed + nodaded + nomomed + f1 + f2 + f3 + f4 + f5 + f6 + f7 + f8 + \n                             momdad14 + sinmom14, data = card_95)\nIV_model2 <- ivreg(lwage76 ~ ed76 + exp76 + exp76_sq_100 + black + south76 + smsa76r + smsa66r + region66 + daded + momed +\n                     nodaded + nomomed + f1 + f2 + f3 + f4 +  f5 + f6 + f7 + f8 + momdad14 + sinmom14 |\n                     nearc4 + exp76 + exp76_sq_100 + black + south76 + smsa76r + smsa66r + region66 + daded + momed +\n                     nodaded + nomomed + f1 + f2 + f3 + f4 + f5 + f6 + f7 + f8 + momdad14 + sinmom14, data = card_95)\n```\n\n\n```{r, results='asis', echo=FALSE}\n# stargazer(reduced_form1_stage1,\n#           reduced_form2_stage1,\n#           reduced_form1_stage2,\n#           reduced_form2_stage2,\n#           IV_model1,\n#           IV_model2,\n#           header=FALSE,\n#           type = 'html',\n#           omit = c(\"f\", \"reg\", \"exp76\", \"smsa\", \"black\", \"south\", \"momed\", \"nodaded\", \"daded\", \"momdad14\", \"sinmom14\", \"Constant\", \"nomomed\", \"smsa66\"),\n#           no.space = TRUE,\n#            add.lines=list(c('Family Background Variables', 'No','Yes', \"No\", \"Yes\", \"No\", \"Yes\")),\n#           omit.stat =c(\"f\", \"adj.rsq\", \"ser\", \"rsq\"),\n#           # notes = NULL,\n#           covariate.labels =c(\"Live Near College in 1966 \", \"Education\"),\n#            dep.var.labels = c(\"Education\", \"Log Hourly Earnings\"),\n#           column.labels   = c(\"Reduced Form (OLS) Estimates\", \"Strucutral (IV) Estimates\"),\n#           column.separate = c(4, 2),\n#           model.names = FALSE\n#           )\n```\n\nCompare this to panel A of Table 3 in @card1995using. Note that the ratio of our reduced form estimates do equal our IV estimates. Between our original OLS estimates (of the structural model), and our IV estimates, we have seven estimates for $\\beta$. We can plot these along with the corresponding 95% confidence intervals.\n\n```{r, echo=FALSE, fig.align='center', fig.asp = 0.7, fig.width = 8, fig.cap =\"test\", warning=FALSE}\nlinear_model1 <- tidy(linear_model1) %>% \n  mutate(model = \"Linear Model 1\")\nlinear_model2 <- tidy(linear_model2) %>% \n  mutate(model = \"Linear Model 2\")\nlinear_model3 <- tidy(linear_model3) %>% \n  mutate(model = \"Linear Model 3\")\nlinear_model4 <- tidy(linear_model4) %>% \n  mutate(model = \"Linear Model 4\")\nlinear_model5 <- tidy(linear_model5) %>% \n  mutate(model = \"Linear Model 5\")\nIV_model1 <- tidy(IV_model1) %>% \n  mutate(model = \"IV Model 1\")\nIV_model2 <- tidy(IV_model2) %>% \n  mutate(model = \"IV Model 2\")\n\nbind_rows(linear_model1,\n          linear_model2,\n          linear_model3,\n          linear_model4,\n          linear_model5,\n          IV_model1,\n          IV_model2) %>% \n  filter(term == \"ed76\") %>% \n  mutate(upper = estimate + 1.965*std.error,\n         lower = estimate - 1.965*std.error) %>% \n  ggplot(aes(model, estimate)) +\n  geom_point() +\n  geom_linerange(aes(ymin = lower, ymax = upper)) +\n  theme_minimal() +\n  labs(x = \"\", y = \"β Estimate, 95% Confidence Interval\")\n```\nWhile our IV estimates are larger, all of our OLS estimates fall within the 95% confidence intervals for the IV estimates. As such, we're not able to conclude that our IV estimates are significantly larger than our OLS estimates.\n\n## Further Reading\n\n**_Technical treatment of IV/2SLS_**: Chapter 5 of @wooldridge2010econometric, Chapter 8 of @greene2003econometric, Chapter 12 of @hansen2022econometrics\n\n**_Testing for Endogeneity_**: Section 8.7 of @davidson2004econometric, @ruud1984tests, @wu1973alternative, @durbin54, @hausman1978specification, @davidson1990specification, @nakamura1981relationships, @chmelarova2007hausman, @baum2003instrumental","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":true,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":false,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":true,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"endog.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.4.554","bibliography":["references.bib"],"theme":"cosmo"},"extensions":{"book":{"multiFile":true}}},"pdf":{"identifier":{"display-name":"PDF","target-format":"pdf","base-format":"pdf"},"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":true,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"xelatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","output-file":"endog.pdf"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"block-headings":true,"bibliography":["references.bib"],"documentclass":"scrreprt"},"extensions":{"book":{"selfContainedOutput":true}}}},"projectFormats":["html","pdf"]}